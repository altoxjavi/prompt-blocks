<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Prompt Blocks">
  <title>Prompt Blocks - Nano Banana Pro Prompt Builder</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    :root {
      --bg-primary: #08080c;
      --bg-secondary: rgba(15, 15, 22, 0.8);
      --bg-tertiary: rgba(20, 20, 30, 0.6);
      --glass-bg: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.12);
      --text-primary: #f0f0f5;
      --text-secondary: #a0a0b0;
      --text-muted: #606070;
      --accent-cyan: #4ECDC4;
      --accent-coral: #FF6B6B;
      --accent-gold: #FFA94D;
      --shadow-soft: 0 4px 24px rgba(0, 0, 0, 0.4);
      --shadow-glow-cyan: 0 0 20px rgba(78, 205, 196, 0.15);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --transition-fast: 0.15s ease;
      --transition-smooth: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .library-panel, .builder-panel, .slots-container, .category-phrases {
      -webkit-user-select: none;
      user-select: none;
    }
    
    .preview-content {
      -webkit-user-select: text;
      user-select: text;
    }
    
    body {
      font-family: 'Space Mono', monospace;
      background: var(--bg-primary);
      background-image: 
        radial-gradient(ellipse at 20% 20%, rgba(78, 205, 196, 0.03) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(255, 107, 107, 0.03) 0%, transparent 50%);
      min-height: 100vh;
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* ============ HEADER ============ */
    .app-header {
      background: var(--bg-secondary);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 14px 24px;
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      position: relative;
      z-index: 100;
    }
    
    .app-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(78, 205, 196, 0.3), rgba(255, 107, 107, 0.3), transparent);
    }
    
    .app-title {
      font-family: 'Syne', sans-serif;
      font-size: 22px;
      font-weight: 800;
      background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 50%, #45B7D1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }
    
    .app-subtitle {
      font-size: 9px;
      color: var(--text-muted);
      margin-top: 3px;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-weight: 400;
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .header-actions button {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      font-weight: 400;
      transition: var(--transition-smooth);
      position: relative;
      overflow: hidden;
    }
    
    .header-actions button::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.05) 100%);
      opacity: 0;
      transition: var(--transition-fast);
    }
    
    .header-actions button:hover {
      background: var(--glass-highlight);
      color: var(--text-primary);
      border-color: rgba(255,255,255,0.15);
      transform: translateY(-1px);
    }
    
    .header-actions button:hover::before {
      opacity: 1;
    }
    
    .header-actions button:active {
      transform: translateY(0) scale(0.98);
    }
    
    .fullscreen-btn {
      background: rgba(78, 205, 196, 0.08) !important;
      border: 1px solid rgba(78, 205, 196, 0.25) !important;
      color: var(--accent-cyan) !important;
    }
    
    .fullscreen-btn:hover {
      background: rgba(78, 205, 196, 0.15) !important;
      box-shadow: var(--shadow-glow-cyan);
    }
    
    .edit-btn {
      background: rgba(255, 107, 107, 0.08) !important;
      border: 1px solid rgba(255, 107, 107, 0.25) !important;
      color: var(--accent-coral) !important;
    }
    
    .edit-btn:hover {
      background: rgba(255, 107, 107, 0.15) !important;
      box-shadow: 0 0 20px rgba(255, 107, 107, 0.15);
    }
    
    .edit-btn.active {
      background: rgba(255, 107, 107, 0.25) !important;
      border-color: var(--accent-coral) !important;
      color: #fff !important;
      box-shadow: 0 0 20px rgba(255, 107, 107, 0.2);
    }
    
    /* ============ MAIN LAYOUT ============ */
    .app-main {
      display: grid;
      grid-template-columns: 300px 1fr 360px;
      flex: 1;
      overflow: hidden;
      height: calc(100vh - 62px);
      gap: 1px;
      background: var(--glass-border);
    }
    
    /* ============ LIBRARY PANEL ============ */
    .library-panel {
      background: var(--bg-secondary);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .library-header {
      padding: 20px 16px 16px;
      border-bottom: 1px solid var(--glass-border);
      flex-shrink: 0;
    }
    
    .library-header h2 {
      font-family: 'Syne', sans-serif;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.5px;
      color: var(--text-primary);
    }
    
    .library-subtitle {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 6px;
      letter-spacing: 0.5px;
    }
    
    .library-categories {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      -webkit-overflow-scrolling: touch;
    }
    
    .add-folder-btn {
      width: 100%;
      padding: 14px;
      margin-bottom: 10px;
      background: transparent;
      border: 1px dashed rgba(78, 205, 196, 0.25);
      border-radius: var(--radius-md);
      color: var(--accent-cyan);
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      cursor: pointer;
      transition: var(--transition-smooth);
    }
    
    .add-folder-btn:hover {
      background: rgba(78, 205, 196, 0.08);
      border-color: rgba(78, 205, 196, 0.4);
      box-shadow: var(--shadow-glow-cyan);
    }
    
    .add-from-blueprint-btn {
      background: rgba(255, 165, 77, 0.08);
      border: 1px solid rgba(255, 165, 77, 0.25);
      color: var(--accent-gold);
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      transition: var(--transition-smooth);
      margin-top: 12px;
      width: 100%;
    }
    
    .add-from-blueprint-btn:hover {
      background: rgba(255, 165, 77, 0.15);
      box-shadow: 0 0 20px rgba(255, 165, 77, 0.1);
    }
    
    /* ============ FOLDER CATEGORIES ============ */
    .library-category {
      margin-bottom: 8px;
      position: relative;
    }
    
    .category-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-left: 3px solid var(--cat-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      cursor: pointer;
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      transition: var(--transition-smooth);
      position: relative;
      overflow: hidden;
    }
    
    .category-header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.02) 100%);
      opacity: 0;
      transition: var(--transition-fast);
    }
    
    .category-header:hover {
      background: var(--glass-highlight);
      border-color: rgba(255,255,255,0.12);
      transform: translateX(2px);
    }
    
    .category-header:hover::before {
      opacity: 1;
    }
    
    .category-header.expanded {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      background: var(--glass-highlight);
    }
    
    .category-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .category-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .category-count {
      background: rgba(255,255,255,0.08);
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 10px;
      color: var(--text-secondary);
      font-weight: 400;
    }
    
    .category-arrow {
      font-size: 10px;
      color: var(--text-muted);
      transition: transform 0.2s ease;
    }
    
    .category-header.expanded .category-arrow {
      transform: rotate(90deg);
    }
    
    .folder-color-btn {
      display: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .folder-color-btn:hover {
      transform: scale(1.15);
      box-shadow: 0 0 12px currentColor;
    }
    
    .library-panel.edit-mode .folder-color-btn {
      display: block;
    }
    
    .folder-action-btn {
      display: none;
      width: 26px;
      height: 26px;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      transition: var(--transition-fast);
      font-size: 12px;
      background: var(--glass-bg);
      color: var(--text-secondary);
    }
    
    .folder-action-btn:hover {
      transform: scale(1.05);
    }
    
    .folder-action-btn:active {
      transform: scale(0.95);
    }
    
    .folder-action-btn.duplicate {
      background: rgba(78, 205, 196, 0.1);
      color: var(--accent-cyan);
    }
    
    .folder-action-btn.duplicate:hover {
      background: rgba(78, 205, 196, 0.2);
      box-shadow: var(--shadow-glow-cyan);
    }
    
    .folder-action-btn.delete {
      background: rgba(255, 107, 107, 0.1);
      color: var(--accent-coral);
    }
    
    .folder-action-btn.delete:hover {
      background: rgba(255, 107, 107, 0.2);
      box-shadow: 0 0 12px rgba(255, 107, 107, 0.2);
    }
    
    .library-panel.edit-mode .folder-action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .library-panel.edit-mode .folder-label {
      cursor: pointer;
      padding: 2px 6px;
      margin: -2px -6px;
      border-radius: 4px;
      transition: var(--transition-fast);
    }
    
    .library-panel.edit-mode .folder-label:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .trash-bin {
      display: none;
      position: sticky;
      bottom: 0;
      padding: 20px;
      background: linear-gradient(to top, var(--bg-secondary) 0%, transparent 100%);
      text-align: center;
    }
    
    .library-panel.edit-mode .trash-bin {
      display: block;
    }
    
    .trash-bin-target {
      padding: 16px 24px;
      border: 2px dashed rgba(255, 107, 107, 0.25);
      border-radius: var(--radius-md);
      color: var(--accent-coral);
      font-size: 13px;
      transition: all 0.2s;
      background: rgba(255, 107, 107, 0.05);
    }
    
    .trash-bin-target.drag-over {
      border-color: #FF6B6B;
      background: rgba(255, 107, 107, 0.2);
      transform: scale(1.02);
    }
    
    .category-phrases {
      padding: 12px;
      background: rgba(10, 10, 15, 0.9);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid var(--glass-border);
      border-top: none;
      border-radius: 0 0 var(--radius-md) var(--radius-md);
      display: none;
      flex-direction: column;
      gap: 6px;
    }
    
    .category-phrases.expanded {
      display: flex;
    }
    
    .phrase-chip {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-left: 3px solid var(--chip-color, #888);
      border-radius: var(--radius-sm);
      font-size: 11px;
      transition: var(--transition-smooth);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      position: relative;
    }
    
    .phrase-chip::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, transparent 100%);
      opacity: 0;
      transition: var(--transition-fast);
      border-radius: inherit;
      pointer-events: none;
    }
    
    .phrase-chip:hover {
      background: var(--glass-highlight);
      border-color: rgba(255,255,255,0.12);
      transform: translateX(3px);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
    }
    
    .phrase-chip:hover::after {
      opacity: 1;
    }
    
    .phrase-chip:active {
      transform: scale(0.98);
      background: rgba(78, 205, 196, 0.1);
    }
    
    .phrase-chip.pressing {
      transform: scale(0.96);
      background: rgba(78, 205, 196, 0.15);
      border-color: var(--accent-cyan);
      box-shadow: var(--shadow-glow-cyan);
    }
    
    .phrase-chip.picked-up {
      opacity: 0.4;
      transform: scale(0.95);
    }
    
    @keyframes wiggle {
      0%, 100% { transform: rotate(-0.5deg); }
      50% { transform: rotate(0.5deg); }
    }
    
    .library-panel.edit-mode .phrase-chip:not(.in-slot) {
      animation: wiggle 0.15s ease-in-out infinite;
    }
    
    .phrase-delete {
      display: none !important;
      position: absolute;
      top: -6px;
      right: -6px;
      width: 18px;
      height: 18px;
      background: var(--accent-coral);
      border: 2px solid var(--bg-primary);
      border-radius: 50%;
      color: #fff;
      font-size: 10px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      transition: var(--transition-fast);
    }
    
    .phrase-delete:hover {
      transform: scale(1.15);
    }
    
    .library-panel.edit-mode .phrase-delete {
      display: flex !important;
    }
    
    .chip-icon {
      font-size: 13px;
      flex-shrink: 0;
    }
    
    .chip-text {
      flex: 1;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    
    .chip-remove {
      display: none;
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 14px;
      padding: 0 4px;
    }
    
    .phrase-chip.in-slot .chip-remove {
      display: block;
    }
    
    .chip-remove:hover {
      color: #FF6B6B;
    }
    
    .add-phrase-btn {
      background: transparent;
      border: 1px dashed rgba(255,255,255,0.1);
      color: var(--text-muted);
      padding: 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      width: 100%;
      transition: var(--transition-smooth);
    }
    
    .add-phrase-btn:hover {
      border-color: rgba(78, 205, 196, 0.3);
      color: var(--accent-cyan);
      background: rgba(78, 205, 196, 0.05);
    }
    
    .add-phrase-form {
      display: none;
      gap: 6px;
    }
    
    .add-phrase-form.active {
      display: flex;
    }
    
    .add-phrase-form input {
      flex: 1;
      background: rgba(0,0,0,0.4);
      border: 1px solid var(--glass-border);
      color: var(--text-primary);
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      transition: var(--transition-fast);
    }
    
    .add-phrase-form input:focus {
      outline: none;
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
    }
    
    .add-phrase-form button {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      transition: var(--transition-fast);
    }
    
    .add-phrase-form button:hover {
      background: var(--glass-highlight);
      color: var(--text-primary);
    }
    
    /* ============ BUILDER PANEL ============ */
    .builder-panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg-primary);
    }
    
    .builder-header {
      padding: 16px 20px;
      background: var(--bg-secondary);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .builder-header h2 {
      font-family: 'Syne', sans-serif;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .clear-btn {
      background: rgba(255, 107, 107, 0.08);
      border: 1px solid rgba(255, 107, 107, 0.2);
      color: var(--accent-coral);
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      transition: var(--transition-smooth);
    }
    
    .clear-btn:hover {
      background: rgba(255, 107, 107, 0.15);
      box-shadow: 0 0 16px rgba(255, 107, 107, 0.1);
    }
    
    /* ============ REFERENCE IMAGES ============ */
    .ref-images-section {
      padding: 16px 20px;
      border-bottom: 1px solid var(--glass-border);
      flex-shrink: 0;
      background: rgba(0, 0, 0, 0.2);
    }
    
    .ref-images-header {
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .ref-images-grid {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .ref-image-slot {
      width: 72px;
      height: 90px;
      border-radius: var(--radius-md);
      overflow: hidden;
      position: relative;
      transition: var(--transition-smooth);
    }
    
    .ref-image-slot.empty {
      border: 2px dashed rgba(255,255,255,0.1);
      background: var(--glass-bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    label.ref-image-slot.empty {
      width: 72px;
      height: 90px;
    }
    
    .ref-image-slot.empty:hover {
      border-color: rgba(78, 205, 196, 0.4);
      background: rgba(78, 205, 196, 0.05);
      box-shadow: var(--shadow-glow-cyan);
    }
    
    .ref-add-icon {
      font-size: 18px;
      color: var(--text-muted);
    }
    
    .ref-add-text {
      font-size: 8px;
      color: var(--text-muted);
      margin-top: 4px;
      letter-spacing: 0.5px;
    }
    
    .ref-image-slot.filled {
      border: 2px solid rgba(78, 205, 196, 0.3);
    }
    
    .ref-image-preview {
      width: 100%;
      height: 52px;
      object-fit: cover;
    }
    
    .ref-role-select {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.9);
      border: none;
      color: var(--text-primary);
      padding: 6px 4px;
      font-family: 'Space Mono', monospace;
      font-size: 8px;
      cursor: pointer;
    }
    
    .ref-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0,0,0,0.8);
      border: none;
      color: #fff;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: var(--transition-fast);
    }
    
    .ref-remove:hover {
      background: var(--accent-coral);
    }
    
    .ref-image-slot:hover .ref-remove {
      opacity: 1;
    }
    
    /* ============ SLOTS ============ */
    .slots-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      -webkit-overflow-scrolling: touch;
    }
    
    .prompt-slot {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      overflow: hidden;
      transition: var(--transition-smooth);
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .prompt-slot:hover {
      border-color: rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
    }
    
    .prompt-slot.tap-ready {
      border-color: var(--slot-color, #4ECDC4);
      box-shadow: 0 0 24px rgba(78, 205, 196, 0.15);
    }
    
    .prompt-slot.drag-hover {
      border-color: var(--slot-color) !important;
      box-shadow: 0 0 32px rgba(78, 205, 196, 0.25);
      transform: scale(1.01);
      background: rgba(78, 205, 196, 0.05);
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }
    
    .prompt-slot.invalid-drop {
      animation: shake 0.3s ease-in-out;
    }
    
    .slot-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-bottom: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.15);
    }
    
    .slot-icon {
      font-size: 13px;
    }
    
    .slot-label {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }
    
    .slot-content {
      padding: 12px;
      min-height: 48px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-content: flex-start;
    }
    
    .slot-placeholder {
      color: var(--text-muted);
      font-size: 10px;
      font-style: italic;
      width: 100%;
      text-align: center;
      padding: 8px;
      opacity: 0.6;
    }
    
    /* ============ PREVIEW PANEL ============ */
    .preview-panel {
      background: var(--bg-secondary);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      display: flex;
      flex-direction: column;
    }
    
    .preview-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      background: rgba(0, 0, 0, 0.15);
    }
    
    .preview-header h2 {
      font-family: 'Syne', sans-serif;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .preview-actions {
      display: flex;
      gap: 8px;
    }
    
    .copy-btn {
      background: linear-gradient(135deg, var(--accent-cyan), #45B7D1);
      border: none;
      color: #000;
      padding: 10px 18px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      font-weight: 700;
      transition: var(--transition-smooth);
      position: relative;
      overflow: hidden;
    }
    
    .copy-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 50%);
      opacity: 0;
      transition: var(--transition-fast);
    }
    
    .copy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(78, 205, 196, 0.35);
    }
    
    .copy-btn:hover::before {
      opacity: 1;
    }
    
    .copy-btn:active {
      transform: translateY(0) scale(0.98);
    }
    
    .copy-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .copy-btn.copied {
      background: linear-gradient(135deg, #82E0AA, #58D68D);
    }
    
    .preview-content {
      flex: 1;
      margin: 0;
      padding: 20px;
      background: rgba(0, 0, 0, 0.25);
      color: var(--text-secondary);
      font-size: 11px;
      line-height: 1.9;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: 'Space Mono', monospace;
    }
    
    .preview-content.empty {
      color: var(--text-muted);
      font-style: italic;
    }
    
    .preview-phrase {
      font-weight: 500;
    }
    
    .preview-label {
      color: var(--text-muted);
    }
    
    .preview-sep {
      color: rgba(255,255,255,0.2);
    }
    
    .preview-ref {
      color: var(--text-muted);
      font-style: italic;
    }
    
    /* ============ CHAT TOGGLE ============ */
    .chat-toggle-btn {
      background: linear-gradient(135deg, rgba(187, 143, 206, 0.15), rgba(167, 123, 186, 0.15));
      border: 1px solid rgba(187, 143, 206, 0.25);
      color: #BB8FCE;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      transition: all 0.2s;
    }
    
    .chat-toggle-btn.active {
      background: linear-gradient(135deg, #BB8FCE, #A77BBA);
      color: #000;
      font-weight: 700;
    }
    
    /* Claude Assistant Panel */
    .assistant-panel {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    
    .assistant-panel.active {
      display: flex;
    }
    
    .assistant-header {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .assistant-header h3 {
      font-family: 'Syne', sans-serif;
      font-size: 14px;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .assistant-close-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #888;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .assistant-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      -webkit-overflow-scrolling: touch;
    }
    
    .assistant-message {
      padding: 12px 14px;
      border-radius: 12px;
      font-size: 12px;
      line-height: 1.6;
      max-width: 95%;
    }
    
    .assistant-message.user {
      background: rgba(78, 205, 196, 0.15);
      border: 1px solid rgba(78, 205, 196, 0.3);
      color: #ccc;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    
    .assistant-message.assistant {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: #ccc;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    
    .assistant-message.system {
      background: rgba(255, 165, 77, 0.1);
      border: 1px solid rgba(255, 165, 77, 0.2);
      color: #FFA94D;
      font-size: 11px;
      text-align: center;
      align-self: center;
    }
    
    .assistant-message.error {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      color: #FF6B6B;
    }
    
    .assistant-message pre {
      background: rgba(0,0,0,0.3);
      padding: 10px;
      border-radius: 6px;
      margin: 8px 0 0 0;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 11px;
    }
    
    .assistant-message .copy-suggestion {
      background: rgba(78, 205, 196, 0.2);
      border: 1px solid rgba(78, 205, 196, 0.3);
      color: #4ECDC4;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 10px;
      cursor: pointer;
      margin-top: 8px;
      display: inline-block;
    }
    
    /* Message animations */
    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .assistant-message {
      animation: messageSlideIn 0.3s ease-out;
    }
    
    /* Blueprint Preview Card */
    .blueprint-preview-card {
      background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(69, 183, 209, 0.1) 100%);
      border: 1px solid rgba(78, 205, 196, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
      animation: cardAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transition: all 0.3s ease;
    }
    
    @keyframes cardAppear {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(10px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    .blueprint-preview-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    
    .blueprint-preview-icon {
      font-size: 24px;
    }
    
    .blueprint-preview-info {
      flex: 1;
    }
    
    .blueprint-preview-name {
      font-family: 'Syne', sans-serif;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }
    
    .blueprint-preview-meta {
      font-size: 10px;
      color: #888;
      margin-top: 2px;
    }
    
    .blueprint-preview-folders {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 12px 0;
      transition: opacity 0.2s;
    }
    
    .blueprint-preview-folder {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 10px;
      color: #aaa;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* Expanded folder details - shown on hover */
    .blueprint-preview-details {
      display: none;
      margin: 12px 0;
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      max-height: 180px;
      overflow-y: auto;
      animation: fadeIn 0.2s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Hover on button shows details */
    .blueprint-create-btn:hover + .blueprint-preview-details,
    .blueprint-preview-details:hover {
      display: block;
    }
    
    .blueprint-create-btn:hover ~ .blueprint-preview-folders {
      display: none;
    }
    
    .preview-folder-section {
      margin-bottom: 10px;
    }
    
    .preview-folder-section:last-child {
      margin-bottom: 0;
    }
    
    .preview-folder-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 5px;
      padding-bottom: 3px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .preview-folder-color {
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }
    
    .preview-folder-phrases {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    
    .preview-phrase-chip {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 9px;
      color: #999;
    }
    
    .blueprint-preview-actions {
      display: flex;
      gap: 8px;
    }
    
    .blueprint-create-btn {
      flex: 1;
      background: linear-gradient(135deg, #4ECDC4, #45B7D1);
      border: none;
      color: #000;
      padding: 12px 16px;
      border-radius: 8px;
      font-family: 'Space Mono', monospace;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .blueprint-create-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
    }
    
    .blueprint-create-btn:active {
      transform: scale(0.98);
    }
    
    .blueprint-create-btn.success {
      background: linear-gradient(135deg, #82E0AA, #58D68D);
    }
    
    @keyframes successPulse {
      0% { box-shadow: 0 0 0 0 rgba(130, 224, 170, 0.6); }
      70% { box-shadow: 0 0 0 15px rgba(130, 224, 170, 0); }
      100% { box-shadow: 0 0 0 0 rgba(130, 224, 170, 0); }
    }
    
    .blueprint-create-btn.success {
      animation: successPulse 0.6s ease-out;
    }
    
    /* Contextual Suggestions */
    .assistant-suggestions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    
    .suggestion-chip {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      color: #888;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .suggestion-chip:hover {
      background: rgba(78, 205, 196, 0.1);
      border-color: rgba(78, 205, 196, 0.3);
      color: #4ECDC4;
    }
    
    .suggestion-chip:active {
      transform: scale(0.95);
    }
    
    /* Enhanced typing indicator with shimmer */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    .assistant-typing {
      display: flex;
      gap: 4px;
      padding: 12px 14px;
      align-self: flex-start;
    }
    
    .assistant-typing span {
      width: 8px;
      height: 8px;
      background: #4ECDC4;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }
    
    .assistant-typing span:nth-child(2) { animation-delay: 0.2s; }
    .assistant-typing span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-4px); opacity: 1; }
    }
    
    .assistant-input-area {
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,0.05);
      background: rgba(0,0,0,0.2);
    }
    
    .assistant-input-wrapper {
      display: flex;
      gap: 8px;
    }
    
    .assistant-input {
      flex: 1;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      color: #fff;
      padding: 12px;
      border-radius: 8px;
      font-family: 'Space Mono', monospace;
      font-size: 12px;
      resize: none;
      min-height: 44px;
      max-height: 120px;
    }
    
    .assistant-input:focus {
      outline: none;
      border-color: #4ECDC4;
    }
    
    .assistant-send-btn {
      background: linear-gradient(135deg, #4ECDC4, #45B7D1);
      border: none;
      color: #000;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Space Mono', monospace;
      font-size: 12px;
      font-weight: 700;
      align-self: flex-end;
    }
    
    .assistant-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .assistant-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    
    .assistant-action-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: #aaa;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 10px;
      cursor: pointer;
    }
    
    .api-key-setup {
      padding: 20px;
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 16px;
    }
    
    .api-key-setup h4 {
      font-family: 'Syne', sans-serif;
      font-size: 16px;
      color: #fff;
    }
    
    .api-key-setup p {
      font-size: 11px;
      color: #888;
      line-height: 1.6;
      max-width: 280px;
      margin: 0 auto;
    }
    
    .api-key-input-group {
      display: flex;
      gap: 8px;
      max-width: 300px;
      margin: 0 auto;
    }
    
    .api-key-input {
      flex: 1;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      color: #fff;
      padding: 10px 12px;
      border-radius: 6px;
      font-family: 'Space Mono', monospace;
      font-size: 11px;
    }
    
    .api-key-input:focus {
      outline: none;
      border-color: #4ECDC4;
    }
    
    .api-key-save-btn {
      background: linear-gradient(135deg, #4ECDC4, #45B7D1);
      border: none;
      color: #000;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      font-weight: 700;
    }
    
    .api-key-link {
      color: #4ECDC4;
      text-decoration: none;
      font-size: 11px;
    }
    
    /* Template bar */
    .template-bar {
      padding: 12px 16px;
      border-top: 1px solid rgba(255,255,255,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0,0,0,0.2);
      flex-shrink: 0;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .template-current {
      font-size: 11px;
      color: #888;
    }
    
    .template-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .template-actions button {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: #aaa;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Space Mono', monospace;
      font-size: 10px;
    }
    
    .template-select {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: #aaa;
      padding: 6px 12px;
      border-radius: 6px;
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      cursor: pointer;
    }
    
    .save-form {
      display: none;
      gap: 6px;
    }
    
    .save-form.active {
      display: flex;
    }
    
    .save-form input {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      width: 130px;
    }
    
    .save-form input:focus {
      outline: none;
      border-color: #4ECDC4;
    }
    
    .hidden-input {
      position: absolute;
      width: 0;
      height: 0;
      opacity: 0;
      overflow: hidden;
      z-index: -1;
    }
    
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: var(--bg-secondary);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      color: var(--text-primary);
      padding: 16px 28px;
      border-radius: var(--radius-md);
      font-family: 'Syne', sans-serif;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.5),
        0 0 40px rgba(78, 205, 196, 0.2);
      z-index: 3000;
      opacity: 0;
      pointer-events: none;
      transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .toast.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
    
    .drag-ghost {
      position: fixed;
      pointer-events: none;
      z-index: 2000;
      padding: 10px 14px;
      background: var(--bg-secondary);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--accent-cyan);
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-family: 'Space Mono', monospace;
      color: var(--accent-cyan);
      font-weight: 600;
      box-shadow: 
        0 12px 40px rgba(0, 0, 0, 0.4),
        0 0 24px rgba(78, 205, 196, 0.3);
      transform: translate(-50%, -50%) scale(1.02);
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .drag-ghost.dropping {
      transform: translate(-50%, -50%) scale(0.9);
      opacity: 0;
    }
    
    /* ============ MODALS ============ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2500;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: #1a1a2e;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 24px;
      width: 320px;
      max-width: 90vw;
    }
    
    .modal h3 {
      font-family: 'Syne', sans-serif;
      font-size: 18px;
      margin-bottom: 16px;
      color: #fff;
    }
    
    .modal input {
      width: 100%;
      padding: 12px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      color: #fff;
      font-family: 'Space Mono', monospace;
      font-size: 13px;
      margin-bottom: 12px;
    }
    
    .modal input:focus {
      outline: none;
      border-color: #4ECDC4;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .modal-actions button {
      padding: 10px 20px;
      border-radius: 6px;
      font-family: 'Space Mono', monospace;
      font-size: 12px;
      cursor: pointer;
    }
    
    .modal-actions .cancel-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: #aaa;
    }
    
    .modal-actions .confirm-btn {
      background: linear-gradient(135deg, #4ECDC4, #45B7D1);
      border: none;
      color: #000;
      font-weight: 700;
    }
    
    .modal label {
      display: block;
      font-size: 11px;
      color: #888;
      margin-bottom: 6px;
    }
    
    .emoji-picker {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    
    .emoji-option {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      background: rgba(255,255,255,0.05);
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
    }
    
    .emoji-option.selected {
      border-color: #4ECDC4;
      background: rgba(78, 205, 196, 0.1);
    }
    
    /* Color picker */
    .color-picker-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1999;
      display: none;
    }
    
    .color-picker-overlay.active {
      display: block;
    }
    
    .color-picker-popover {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1a1a2e;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 16px;
      padding: 16px;
      z-index: 2000;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
      display: none;
      width: 280px;
    }
    
    .color-picker-popover.active {
      display: block;
    }
    
    .color-picker-title {
      font-size: 11px;
      color: #888;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
    }
    
    .color-picker-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      justify-items: center;
    }
    
    .color-option {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.15s;
    }
    
    .color-option:hover {
      transform: scale(1.1);
      border-color: rgba(255,255,255,0.5);
    }
    
    .color-option.selected {
      border-color: #fff;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
    }
    
    /* Blueprint modal */
    .blueprint-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 2999;
      display: none;
    }
    
    .blueprint-overlay.active {
      display: block;
    }
    
    .blueprint-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1a1a2e;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 20px;
      padding: 24px;
      z-index: 3000;
      box-shadow: 0 30px 80px rgba(0,0,0,0.8);
      display: none;
      max-width: 90vw;
      max-height: 85vh;
      width: 600px;
      overflow: hidden;
    }
    
    .blueprint-modal.active {
      display: block;
    }
    
    .blueprint-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .blueprint-modal-header h3 {
      font-family: 'Syne', sans-serif;
      font-size: 18px;
      color: #fff;
      margin: 0;
    }
    
    .blueprint-close-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #888;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
    }
    
    .blueprint-modal-description {
      font-size: 12px;
      color: #666;
      margin-bottom: 20px;
    }
    
    .blueprint-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
      max-height: 55vh;
      overflow-y: auto;
      padding: 4px;
    }
    
    .blueprint-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    
    .blueprint-card:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(78, 205, 196, 0.3);
      transform: translateY(-2px);
    }
    
    .blueprint-card.active {
      border-color: #4ECDC4;
      background: rgba(78, 205, 196, 0.1);
    }
    
    .blueprint-card.blank-blueprint {
      border-style: dashed;
      border-color: rgba(78, 205, 196, 0.3);
      background: rgba(78, 205, 196, 0.03);
    }
    
    .blueprint-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .blueprint-icon {
      font-size: 20px;
    }
    
    .blueprint-name {
      font-family: 'Syne', sans-serif;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      flex: 1;
    }
    
    .blueprint-delete-btn {
      background: rgba(255, 107, 107, 0.2);
      border: none;
      color: #FF6B6B;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      opacity: 0;
    }
    
    .blueprint-card:hover .blueprint-delete-btn {
      opacity: 1;
    }
    
    .blueprint-export-btn {
      background: rgba(130, 224, 170, 0.2);
      border: none;
      color: #82E0AA;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      opacity: 0;
      margin-right: 4px;
    }
    
    .blueprint-card:hover .blueprint-export-btn {
      opacity: 1;
    }
    
    .blueprint-description {
      font-size: 11px;
      color: #888;
      line-height: 1.4;
      margin-bottom: 8px;
    }
    
    .blueprint-meta {
      font-size: 10px;
      color: #555;
      font-family: 'Space Mono', monospace;
    }
    
    .blueprint-active-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #4ECDC4;
      color: #000;
      font-size: 9px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 10px;
      text-transform: uppercase;
    }
    
    .blueprint-modal-actions {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .blueprint-save-btn, .blueprint-import-btn {
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Space Mono', monospace;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .blueprint-save-btn {
      background: rgba(78, 205, 196, 0.15);
      border: 1px solid rgba(78, 205, 196, 0.3);
      color: #4ECDC4;
    }
    
    .blueprint-import-btn {
      background: rgba(255, 165, 77, 0.15);
      border: 1px solid rgba(255, 165, 77, 0.3);
      color: #FFA94D;
    }
    
    /* Import Text Modal */
    .import-text-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1a1a2e;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 20px;
      padding: 24px;
      z-index: 3000;
      box-shadow: 0 30px 80px rgba(0,0,0,0.8);
      display: none;
      max-width: 90vw;
      max-height: 85vh;
      width: 500px;
    }
    
    .import-text-modal.active {
      display: block;
    }
    
    .import-text-area {
      width: 100%;
      height: 300px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #ccc;
      padding: 12px;
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      resize: none;
      margin-bottom: 16px;
    }
    
    .import-text-area:focus {
      outline: none;
      border-color: #4ECDC4;
    }
    
    .import-text-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .import-text-actions button {
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Space Mono', monospace;
      font-size: 12px;
    }
    
    /* Add folder modal */
    .add-folder-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 2999;
      display: none;
    }
    
    .add-folder-overlay.active {
      display: block;
    }
    
    .add-folder-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1a1a2e;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 20px;
      padding: 24px;
      z-index: 3000;
      box-shadow: 0 30px 80px rgba(0,0,0,0.8);
      display: none;
      max-width: 90vw;
      max-height: 85vh;
      width: 500px;
      overflow: hidden;
    }
    
    .add-folder-modal.active {
      display: block;
    }
    
    .add-folder-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .add-folder-modal-header h3 {
      font-family: 'Syne', sans-serif;
      font-size: 18px;
      color: #fff;
      margin: 0;
    }
    
    .add-folder-modal-description {
      font-size: 12px;
      color: #666;
      margin-bottom: 20px;
    }
    
    .add-folder-grid {
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .add-folder-blueprint-section {
      margin-bottom: 20px;
    }
    
    .add-folder-blueprint-title {
      font-family: 'Syne', sans-serif;
      font-size: 13px;
      color: #888;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .add-folder-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .add-folder-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .add-folder-item:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(78, 205, 196, 0.3);
    }
    
    .add-folder-item-icon {
      font-size: 14px;
    }
    
    .add-folder-item-label {
      font-size: 11px;
      color: #ccc;
    }
    
    .add-folder-item-badge {
      font-size: 9px;
      color: #666;
      background: rgba(255,255,255,0.05);
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.02);
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
    }
    
    @media (max-width: 1100px) {
      .app-main {
        grid-template-columns: 280px 1fr 320px;
      }
    }
    
    @media (max-width: 900px) {
      .app-main {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
        height: auto;
      }
      .library-panel {
        max-height: 280px;
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.05);
      }
      .preview-panel {
        border-left: none;
        border-top: 1px solid rgba(255,255,255,0.05);
      }
      .preview-content {
        min-height: 180px;
      }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div>
      <h1 class="app-title"> Prompt Blocks</h1>
      <p class="app-subtitle">Nano Banana Pro Prompt Builder</p>
    </div>
    <div class="header-actions">
      <button class="blueprint-btn" id="blueprintBtn" onclick="openBlueprintModal()"> Portrait</button>
      <button class="edit-btn" id="editBtn" onclick="toggleEditMode()"> Edit</button>
      <button class="fullscreen-btn" onclick="toggleFullscreen()"> Fullscreen</button>
      <button onclick="location.reload()"> Refresh</button>
      <button onclick="window.open('https://aistudio.google.com', '_blank')">AI Studio </button>
    </div>
  </header>
  
  <main class="app-main">
    <aside class="library-panel" id="libraryPanel">
      <div class="library-header">
        <h2> Blueprint Structure</h2>
        <p class="library-subtitle">Hold + drag to slots</p>
        <button class="add-from-blueprint-btn" onclick="openAddFolderModal()"> Add Folder from Blueprint</button>
      </div>
      <div class="library-categories" id="libraryCategories"></div>
      <div class="trash-bin" id="trashBin">
        <div class="trash-bin-target" id="trashBinTarget">
          <span class="trash-icon"></span>
          Drop here to delete
        </div>
      </div>
    </aside>
    
    <section class="builder-panel">
      <div class="builder-header">
        <h2> Build Your Prompt</h2>
        <button class="clear-btn" onclick="clearAllSlots()">Clear All</button>
      </div>
      <div class="ref-images-section">
        <div class="ref-images-header"> Reference Images</div>
        <div class="ref-images-grid" id="refImagesGrid"></div>
      </div>
      <div class="slots-container" id="slotsContainer"></div>
    </section>
    
    <aside class="preview-panel" id="previewPanel">
      <div class="preview-header">
        <h2 id="previewTitle"> Generated Prompt</h2>
        <div class="preview-actions">
          <button class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleAssistant()"> Assistant</button>
          <button class="copy-btn" id="copyBtn" onclick="copyPrompt()"> Copy</button>
        </div>
      </div>
      <pre class="preview-content empty" id="previewContent">Start adding phrases to build your prompt...</pre>
      
      <div class="assistant-panel" id="assistantPanel">
        <div class="assistant-header">
          <h3> Claude Assistant</h3>
          <button class="assistant-close-btn" onclick="toggleAssistant()"></button>
        </div>
        <div class="api-key-setup" id="apiKeySetup">
          <div>
            <h4> API Key Required</h4>
            <p>To use the Claude Assistant, you'll need an Anthropic API key. Your key is stored locally and never sent anywhere except Anthropic's servers.</p>
          </div>
          <div class="api-key-input-group">
            <input type="password" class="api-key-input" id="apiKeyInput" placeholder="sk-ant-...">
            <button class="api-key-save-btn" onclick="saveApiKey()">Save</button>
          </div>
          <a href="https://console.anthropic.com/settings/keys" target="_blank" class="api-key-link">Get your API key </a>
        </div>
        <div class="assistant-messages" id="assistantMessages" style="display: none;">
          <div class="assistant-message system">Paste your prompt idea or describe what you're trying to create. I'll help you improve it!</div>
        </div>
        <div class="assistant-input-area" id="assistantInputArea" style="display: none;">
          <div class="assistant-input-wrapper">
            <textarea class="assistant-input" id="assistantInput" placeholder="Paste your prompt or describe your idea..." rows="2"></textarea>
            <button class="assistant-send-btn" id="assistantSendBtn" onclick="sendToAssistant()">Send</button>
          </div>
          <div class="assistant-suggestions" id="assistantSuggestions">
            <button class="suggestion-chip" onclick="useSuggestion('Create a blueprint for portrait photography')"> Create a blueprint...</button>
            <button class="suggestion-chip" onclick="useSuggestion('Improve this prompt to be more detailed')"> Improve my prompt</button>
            <button class="suggestion-chip" onclick="useSuggestion('Make it more cinematic')"> More cinematic</button>
          </div>
          <div class="assistant-actions">
            <button class="assistant-action-btn" onclick="useCurrentPrompt()"> Use current prompt</button>
            <button class="assistant-action-btn" onclick="clearChat()"> Clear chat</button>
          </div>
        </div>
      </div>
      
      <div class="template-bar" id="templateBar">
        <div class="template-current" id="templateCurrent"> Untitled Prompt</div>
        <div class="template-actions">
          <div class="save-form" id="saveForm">
            <input type="text" id="saveNameInput" placeholder="Template name...">
            <button onclick="saveTemplate()">Save</button>
            <button onclick="hideSaveForm()"></button>
          </div>
          <button id="saveBtn" onclick="showSaveForm()"> Save</button>
          <select class="template-select" id="templateSelect" onchange="loadTemplate(this.value)">
            <option value=""> Load...</option>
          </select>
        </div>
      </div>
    </aside>
  </main>
  
  <input type="file" accept="image/*" class="hidden-input" id="imageInput" onchange="handleImageSelect(event)">
  <input type="file" accept=".json,.txt" id="blueprintFileInput" style="display:none" onchange="handleBlueprintImport(event)">
  <input type="file" accept=".txt" id="textBlueprintInput" style="display:none" onchange="handleTextBlueprintImport(event)">
  
  <div class="drag-ghost" id="dragGhost" style="display: none;"></div>
  <div class="toast" id="toast"> Copied!</div>
  
  <div class="color-picker-overlay" id="colorPickerOverlay"></div>
  <div class="color-picker-popover" id="colorPickerModal">
    <div class="color-picker-title">Choose Color</div>
    <div class="color-picker-grid" id="colorPickerGrid"></div>
  </div>
  
  <div class="modal-overlay" id="folderModal">
    <div class="modal">
      <h3>Create New Folder</h3>
      <label>Folder Name</label>
      <input type="text" id="newFolderName" placeholder="e.g., Backgrounds">
      <label>Icon</label>
      <div class="emoji-picker" id="emojiPicker">
        <div class="emoji-option selected" data-emoji=""></div>
        <div class="emoji-option" data-emoji=""></div>
        <div class="emoji-option" data-emoji=""></div>
        <div class="emoji-option" data-emoji=""></div>
        <div class="emoji-option" data-emoji=""></div>
        <div class="emoji-option" data-emoji=""></div>
        <div class="emoji-option" data-emoji=""></div>
        <div class="emoji-option" data-emoji=""></div>
        <div class="emoji-option" data-emoji=""></div>
        <div class="emoji-option" data-emoji=""></div>
        <div class="emoji-option" data-emoji=""></div>
        <div class="emoji-option" data-emoji=""></div>
      </div>
      <div class="modal-actions">
        <button class="cancel-btn" onclick="closeFolderModal()">Cancel</button>
        <button class="confirm-btn" onclick="createNewFolder()">Create</button>
      </div>
    </div>
  </div>
  
  <div class="blueprint-overlay" id="blueprintOverlay"></div>
  <div class="blueprint-modal" id="blueprintModal">
    <div class="blueprint-modal-header">
      <h3> Blueprints</h3>
      <button class="blueprint-close-btn" onclick="closeBlueprintModal()"></button>
    </div>
    <div class="blueprint-modal-description">Choose a prompt structure template</div>
    <div class="blueprint-grid" id="blueprintGrid"></div>
    <div class="blueprint-modal-actions">
      <button class="blueprint-import-btn" onclick="triggerTextBlueprintImport()"> Import Text</button>
      <button class="blueprint-import-btn" onclick="triggerBlueprintImport()"> Import JSON</button>
      <button class="blueprint-save-btn" onclick="saveCurrentAsBlueprint()"> Save Current</button>
    </div>
  </div>
  
  <div class="blueprint-overlay" id="importTextOverlay"></div>
  <div class="import-text-modal" id="importTextModal">
    <div class="blueprint-modal-header">
      <h3> Import Text Blueprint</h3>
      <button class="blueprint-close-btn" onclick="closeImportTextModal()"></button>
    </div>
    <div class="blueprint-modal-description">Paste blueprint text (from Claude or manual creation)</div>
    <textarea class="import-text-area" id="importTextArea" placeholder="BLUEPRINT: My Blueprint
ICON: 
DESCRIPTION: My custom blueprint

FOLDER: Category Name |  | #4ECDC4
- Phrase one
- Phrase two
- Phrase three"></textarea>
    <div class="import-text-actions">
      <button class="cancel-btn" onclick="closeImportTextModal()">Cancel</button>
      <button class="confirm-btn" onclick="parseAndImportTextBlueprint()">Import</button>
    </div>
  </div>
  
  <div class="add-folder-overlay" id="addFolderOverlay"></div>
  <div class="add-folder-modal" id="addFolderModal">
    <div class="add-folder-modal-header">
      <h3> Add Folder from Blueprint</h3>
      <button class="blueprint-close-btn" onclick="closeAddFolderModal()"></button>
    </div>
    <div class="add-folder-modal-description">Select a folder to add to your current structure</div>
    <div class="add-folder-grid" id="addFolderGrid"></div>
  </div>

  <script>
    // ============ DATA ============
    const DEFAULT_CATEGORIES = [
      { id: 'instruction', label: 'Instruction', icon: '', color: '#74B9FF' },
      { id: 'subject', label: 'Subject', icon: '', color: '#FF6B6B' },
      { id: 'pose', label: 'Pose / Action', icon: '', color: '#4ECDC4' },
      { id: 'environment', label: 'Environment', icon: '', color: '#45B7D1' },
      { id: 'camera', label: 'Camera', icon: '', color: '#BB8FCE' },
      { id: 'lighting', label: 'Lighting', icon: '', color: '#F7DC6F' },
      { id: 'color', label: 'Color Palette', icon: '', color: '#FFA94D' },
      { id: 'style', label: 'Style', icon: '', color: '#85C1E9' },
      { id: 'mood', label: 'Mood', icon: '', color: '#F1948A' },
      { id: 'constraints', label: 'Constraints', icon: '', color: '#82E0AA' },
      { id: 'quality', label: 'Quality', icon: '', color: '#D7BDE2' }
    ];
    
    const DEFAULT_PHRASES = {
      instruction: [
        "Generate a photograph of",
        "Create a cinematic still of",
        "Produce a professional portrait of",
        "Render a hyper-realistic image of",
        "Design a conceptual image featuring",
        "Capture a candid moment of"
      ],
      subject: [
        "A confident man in his late 20s",
        "A woman with striking angular features",
        "An elderly person with weathered hands",
        "A curious child with wide eyes",
        "A weathered fisherman",
        "An elegant dancer mid-movement",
        "A street musician lost in melody",
        "[Use reference image for identity]",
        "A solitary figure in silhouette",
        "A vintage camera on worn leather",
        "An antique pocket watch",
        "Fresh flowers in morning dew",
        "A steaming cup of coffee"
      ],
      pose: [
        "standing with arms crossed",
        "seated, leaning forward",
        "leaning against weathered wall",
        "hands clasped behind back",
        "walking toward camera",
        "mid-gesture, hands expressive",
        "caught mid-laugh",
        "reaching toward soft light",
        "frozen in graceful motion",
        "looking over shoulder",
        "adjusting collar, eyes downcast",
        "running fingers through hair"
      ],
      environment: [
        "neon-lit Tokyo alley at night",
        "rain-slicked city street",
        "bustling night market",
        "graffiti-covered underpass",
        "rooftop overlooking skyline",
        "cozy vintage coffee shop",
        "sun-drenched Mediterranean courtyard",
        "fog-shrouded forest at dawn",
        "serene mountain lake",
        "golden wheat field at sunset",
        "minimal white studio",
        "moody dark studio",
        "warmly lit library",
        "industrial loft with brick",
        "abstract gradient background",
        "bokeh lights backdrop"
      ],
      camera: [
        "85mm portrait lens, f/1.4",
        "50mm standard, f/2.8",
        "35mm wide angle, f/8",
        "24mm ultra-wide, dramatic",
        "135mm telephoto, compressed",
        "macro lens, extreme close-up",
        "eye level, direct connection",
        "low angle, looking up",
        "high angle, looking down",
        "Dutch angle, tilted",
        "tight close-up on face",
        "medium shot, waist up",
        "full body with environment",
        "extreme wide establishing",
        "over-the-shoulder perspective"
      ],
      lighting: [
        "golden hour, warm backlight",
        "soft diffused overcast",
        "harsh midday sun",
        "blue hour twilight",
        "dappled light through leaves",
        "window light from side",
        "neon glow cyan and magenta",
        "warm tungsten interior",
        "harsh overhead spotlight",
        "ring light, even facial",
        "dramatic chiaroscuro",
        "Rembrandt lighting",
        "rim lighting, glowing edges",
        "split lighting, half shadow",
        "butterfly lighting",
        "moody low-key",
        "bright high-key",
        "cinematic stormy lighting"
      ],
      color: [
        "warm earth tones",
        "cool blue shadows, warm highlights",
        "neutral balanced palette",
        "monochromatic, single hue",
        "complementary orange and teal",
        "analogous sunset warm hues",
        "muted desaturated, film-like",
        "rich saturated, punchy",
        "pastel soft, dreamy",
        "dark moody, deep shadows",
        "Kodak Portra warm skin",
        "Fuji 400H green undertones",
        "Cinestill 800T tungsten shift"
      ],
      style: [
        "editorial portrait photography",
        "documentary photojournalism",
        "fine art conceptual",
        "commercial advertising",
        "street photography candid",
        "fashion editorial high-end",
        "lifestyle natural moments",
        "cinematic film still",
        "vintage 1970s film aesthetic",
        "noir high contrast drama",
        "indie film intimate feel",
        "Renaissance painting influence",
        "Dutch Golden Age lighting",
        "shot on Hasselblad medium format",
        "35mm film grain texture",
        "large format sharp detail"
      ],
      mood: [
        "quiet confidence",
        "joyful exuberance",
        "peaceful serenity",
        "hopeful optimism",
        "warm nostalgia",
        "playful whimsy",
        "dramatic tension",
        "raw vulnerability",
        "powerful determination",
        "passionate intensity",
        "melancholic reflection",
        "wistful longing",
        "mysterious intrigue",
        "thoughtful solitude",
        "ethereal dreamlike",
        "gritty authentic",
        "epic grandeur",
        "intimate connection"
      ],
      constraints: [
        "MUST maintain exact facial features",
        "MUST preserve unique characteristics",
        "MUST feel authentic, not AI-generated",
        "MUST have natural skin texture",
        "MUST include subtle imperfections",
        "Avoid uncanny valley smoothness",
        "Maintain realistic proportions",
        "NEVER include text or watermarks",
        "NEVER add artificial lens flares",
        "Avoid over-sharpening artifacts",
        "Keep composition balanced",
        "Maintain clear focal point",
        "Ensure proper headroom"
      ],
      quality: [
        "photorealistic, indistinguishable",
        "8K resolution, extreme detail",
        "4K cinematic quality",
        "tack sharp focus on subject",
        "professional color grading",
        "properly exposed, full dynamic range",
        "film grain, Kodak Portra 400",
        "Fujifilm Pro 400H emulation",
        "medium format film quality",
        "print-ready resolution",
        "gallery exhibition quality",
        "magazine cover worthy"
      ]
    };
    
    const REFERENCE_ROLES = ['Identity', 'Composition', 'Lighting', 'Style', 'Full Recreation'];
    
    const DEFAULT_BLUEPRINTS = [
      {
        id: 'portrait',
        name: 'Portrait',
        icon: '',
        description: 'People, headshots, character studies',
        categories: [
          { id: 'instruction', label: 'Instruction', icon: '', color: '#74B9FF' },
          { id: 'subject', label: 'Subject', icon: '', color: '#FF6B6B' },
          { id: 'pose', label: 'Pose / Action', icon: '', color: '#4ECDC4' },
          { id: 'environment', label: 'Environment', icon: '', color: '#45B7D1' },
          { id: 'camera', label: 'Camera', icon: '', color: '#BB8FCE' },
          { id: 'lighting', label: 'Lighting', icon: '', color: '#F7DC6F' },
          { id: 'color', label: 'Color Palette', icon: '', color: '#FFA94D' },
          { id: 'style', label: 'Style', icon: '', color: '#85C1E9' },
          { id: 'mood', label: 'Mood', icon: '', color: '#F1948A' },
          { id: 'constraints', label: 'Constraints', icon: '', color: '#82E0AA' },
          { id: 'quality', label: 'Quality', icon: '', color: '#D7BDE2' }
        ]
      },
      {
        id: 'minimal',
        name: 'Minimal',
        icon: '',
        description: 'Quick, simple prompt structure',
        categories: [
          { id: 'instruction', label: 'Instruction', icon: '', color: '#74B9FF' },
          { id: 'subject', label: 'Subject', icon: '', color: '#FF6B6B' },
          { id: 'style', label: 'Style', icon: '', color: '#4ECDC4' },
          { id: 'quality', label: 'Quality', icon: '', color: '#D7BDE2' }
        ]
      },
      {
        id: 'cinematic',
        name: 'Cinematic',
        icon: '',
        description: 'Film stills, movie scenes',
        categories: [
          { id: 'instruction', label: 'Instruction', icon: '', color: '#74B9FF' },
          { id: 'subject', label: 'Scene Description', icon: '', color: '#FF6B6B' },
          { id: 'pose', label: 'Action', icon: '', color: '#4ECDC4' },
          { id: 'environment', label: 'Setting', icon: '', color: '#45B7D1' },
          { id: 'camera', label: 'Cinematography', icon: '', color: '#BB8FCE' },
          { id: 'lighting', label: 'Lighting', icon: '', color: '#F7DC6F' },
          { id: 'color', label: 'Color Grade', icon: '', color: '#85C1E9' },
          { id: 'mood', label: 'Mood / Tone', icon: '', color: '#F1948A' },
          { id: 'quality', label: 'Quality', icon: '', color: '#D7BDE2' }
        ]
      },
      {
        id: 'landscape',
        name: 'Landscape',
        icon: '',
        description: 'Scenic vistas, nature, environments',
        categories: [
          { id: 'instruction', label: 'Instruction', icon: '', color: '#74B9FF' },
          { id: 'environment', label: 'Location', icon: '', color: '#FF6B6B' },
          { id: 'lighting', label: 'Time of Day', icon: '', color: '#FFA94D' },
          { id: 'mood', label: 'Atmosphere', icon: '', color: '#A29BFE' },
          { id: 'camera', label: 'Composition', icon: '', color: '#4ECDC4' },
          { id: 'color', label: 'Color Palette', icon: '', color: '#F7DC6F' },
          { id: 'style', label: 'Style', icon: '', color: '#85C1E9' },
          { id: 'quality', label: 'Quality', icon: '', color: '#D7BDE2' }
        ]
      }
    ];
    
    const COLOR_PALETTE = [
      '#FF6B6B', '#FF8E72', '#FFA94D', '#FFD43B', '#F7DC6F', '#C9E4CA',
      '#4ECDC4', '#45B7D1', '#74B9FF', '#A29BFE', '#BB8FCE', '#F1948A',
      '#82E0AA', '#85C1E9', '#D7BDE2', '#E8DAEF', '#FADBD8', '#F5CBA7',
      '#5DADE2', '#48C9B0', '#58D68D', '#F4D03F', '#EB984E', '#EC7063',
      '#ABB2B9', '#AEB6BF', '#D5DBDB', '#FDEBD0', '#E8F8F5', '#EBF5FB'
    ];
    
    // ============ STATE ============
    let categories = [];
    let library = {};
    let slots = {};
    let references = [
      { image: null, role: 'Identity' },
      { image: null, role: 'Composition' },
      { image: null, role: 'Lighting' }
    ];
    let templates = [];
    let currentTemplateName = '';
    let expandedCategory = null;
    let editMode = false;
    let activeImageSlot = null;
    let activeColorPicker = null;
    let customBlueprints = [];
    let currentBlueprintId = 'portrait';
    
    let isDragging = false;
    let dragData = null;
    let dragGhost = null;
    let pressTimer = null;
    let pressStartChip = null;
    let touchStartPos = { x: 0, y: 0 };
    let selectedEmoji = '';
    let editDragType = null;
    let editDragData = null;
    
    // Assistant state
    let assistantActive = false;
    let chatHistory = [];
    let isWaitingForResponse = false;
    
    // ============ HELPERS ============
    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    
    function escapeHTML(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      if (navigator.vibrate) navigator.vibrate(30);
      setTimeout(() => toast.classList.remove('show'), 1500);
    }
    
    // ============ STORAGE ============
    function loadFromStorage() {
      try {
        const saved = localStorage.getItem('promptBlocksV2');
        return saved ? JSON.parse(saved) : null;
      } catch (e) { return null; }
    }
    
    function saveToStorage() {
      try {
        localStorage.setItem('promptBlocksV2', JSON.stringify({
          categories, library, templates, customBlueprints, currentBlueprintId
        }));
      } catch (e) {}
    }
    
    function initializeData() {
      const saved = loadFromStorage();
      if (saved && saved.categories && saved.categories.length > 0) {
        categories = saved.categories;
        library = saved.library || {};
        templates = saved.templates || [];
        customBlueprints = saved.customBlueprints || [];
        currentBlueprintId = saved.currentBlueprintId || 'portrait';
      } else {
        categories = [...DEFAULT_CATEGORIES];
        library = JSON.parse(JSON.stringify(DEFAULT_PHRASES));
        currentBlueprintId = 'portrait';
      }
      categories.forEach(cat => {
        if (!slots[cat.id]) slots[cat.id] = [];
      });
    }
    
    // ============ EDIT MODE ============
    function toggleEditMode() {
      editMode = !editMode;
      const btn = document.getElementById('editBtn');
      const panel = document.getElementById('libraryPanel');
      btn.classList.toggle('active', editMode);
      btn.textContent = editMode ? ' Done' : ' Edit';
      panel.classList.toggle('edit-mode', editMode);
      if (!editMode) saveToStorage();
      renderLibrary();
    }
    
    // ============ RENDERING ============
    function renderLibrary() {
      const container = document.getElementById('libraryCategories');
      container.innerHTML = '';
      
      const addBtn = document.createElement('button');
      addBtn.className = 'add-folder-btn';
      addBtn.textContent = '+ Add New Folder';
      addBtn.onclick = openFolderModal;
      container.appendChild(addBtn);
      
      categories.forEach((category, idx) => {
        const phrases = library[category.id] || [];
        const isExpanded = expandedCategory === category.id;
        const bgGradient = `linear-gradient(135deg, ${hexToRgba(category.color, 0.25)} 0%, ${hexToRgba(category.color, 0.15)} 100%)`;
        
        const div = document.createElement('div');
        div.className = 'library-category';
        div.dataset.categoryId = category.id;
        
        div.innerHTML = `
          <div class="category-header ${isExpanded ? 'expanded' : ''}" 
               style="--cat-color: ${category.color}; background: ${bgGradient}"
               data-folder-id="${category.id}" onclick="toggleCategory('${category.id}')">
            <div class="category-header-left">
              <span class="folder-icon">${category.icon}</span>
              <span class="folder-label" data-category-id="${category.id}">${category.label}</span>
            </div>
            <div class="category-header-right">
              <button class="folder-action-btn duplicate" data-category-id="${category.id}" title="Duplicate"></button>
              <button class="folder-action-btn delete" data-category-id="${category.id}" title="Delete"></button>
              <button class="folder-color-btn" style="background: ${category.color}" data-category-id="${category.id}"></button>
              <span class="category-count">${phrases.length}</span>
              <span class="category-arrow"></span>
            </div>
          </div>
          <div class="category-phrases ${isExpanded ? 'expanded' : ''}" style="--cat-color: ${category.color}">
            ${phrases.map((p, i) => `
              <div class="phrase-chip" style="--chip-color: ${category.color}" 
                   data-phrase="${escapeHTML(p)}" data-category="${category.id}" data-index="${i}">
                <button class="phrase-delete" onclick="event.stopPropagation(); deletePhrase('${category.id}', ${i})"></button>
                <span class="chip-icon">${category.icon}</span>
                <span class="chip-text">${escapeHTML(p)}</span>
              </div>
            `).join('')}
            <div class="add-phrase-form" id="addForm-${category.id}">
              <input type="text" placeholder="New phrase..." onkeydown="handleAddKeydown(event, '${category.id}')">
              <button onclick="addPhraseFromForm('${category.id}')">Add</button>
              <button onclick="hideAddForm('${category.id}')"></button>
            </div>
            <button class="add-phrase-btn" id="addBtn-${category.id}" onclick="showAddForm('${category.id}')">+ Add phrase</button>
          </div>
        `;
        container.appendChild(div);
      });
      
      document.querySelectorAll('.library-panel .phrase-chip').forEach(attachChipListeners);
      document.querySelectorAll('.library-panel .category-header').forEach(attachFolderListeners);
    }
    
    function renderSlots() {
      const container = document.getElementById('slotsContainer');
      container.innerHTML = '';
      
      categories.forEach(cat => {
        const phrases = slots[cat.id] || [];
        const bgGradient = `linear-gradient(135deg, ${hexToRgba(cat.color, 0.3)} 0%, ${hexToRgba(cat.color, 0.2)} 100%)`;
        
        const div = document.createElement('div');
        div.className = 'prompt-slot';
        div.style.setProperty('--slot-color', cat.color);
        div.dataset.category = cat.id;
        
        div.innerHTML = `
          <div class="slot-header" style="background: ${bgGradient}">
            <span class="slot-icon">${cat.icon}</span>
            <span class="slot-label">${cat.label}</span>
          </div>
          <div class="slot-content" data-category="${cat.id}">
            ${phrases.length === 0 
              ? `<div class="slot-placeholder">Drop ${cat.label.toLowerCase()} here...</div>`
              : phrases.map((p, i) => `
                <div class="phrase-chip in-slot" style="--chip-color: ${cat.color}" 
                     data-phrase="${escapeHTML(p)}" data-category="${cat.id}" data-index="${i}">
                  <span class="chip-icon">${cat.icon}</span>
                  <span class="chip-text">${escapeHTML(p)}</span>
                  <button class="chip-remove" onclick="event.stopPropagation(); removeFromSlot('${cat.id}', ${i})"></button>
                </div>
              `).join('')
            }
          </div>
        `;
        container.appendChild(div);
      });
    }
    
    function renderReferences() {
      const container = document.getElementById('refImagesGrid');
      container.innerHTML = '';
      
      references.forEach((ref, idx) => {
        if (ref.image) {
          const div = document.createElement('div');
          div.className = 'ref-image-slot filled';
          div.innerHTML = `
            <img src="${ref.image}" class="ref-image-preview">
            <select class="ref-role-select" onchange="changeRefRole(${idx}, this.value)">
              ${REFERENCE_ROLES.map(r => `<option value="${r}" ${ref.role === r ? 'selected' : ''}>${r}</option>`).join('')}
            </select>
            <button class="ref-remove" onclick="removeRefImage(${idx})"></button>
          `;
          container.appendChild(div);
        } else {
          const label = document.createElement('label');
          label.className = 'ref-image-slot empty';
          label.setAttribute('for', 'imageInput');
          label.innerHTML = `<div class="ref-add-icon">+</div><div class="ref-add-text">Add Ref</div>`;
          label.addEventListener('mousedown', () => activeImageSlot = idx);
          label.addEventListener('touchstart', () => activeImageSlot = idx, { passive: true });
          container.appendChild(label);
        }
      });
      
      if (references.length < 6) {
        const addSlot = document.createElement('div');
        addSlot.className = 'ref-image-slot empty';
        addSlot.innerHTML = `<div class="ref-add-icon">+</div><div class="ref-add-text">More</div>`;
        addSlot.onclick = () => { references.push({ image: null, role: 'Style' }); renderReferences(); };
        container.appendChild(addSlot);
      }
    }
    
    function renderPreview() {
      const preview = document.getElementById('previewContent');
      const copyBtn = document.getElementById('copyBtn');
      let htmlParts = [];
      let textParts = [];
      
      const activeRefs = references.filter(r => r.image);
      if (activeRefs.length > 0) {
        htmlParts.push('<span class="preview-ref">[Reference Images Attached]</span>');
        textParts.push('[Reference Images Attached]');
        activeRefs.forEach((ref, i) => {
          htmlParts.push(`<span class="preview-ref">Image ${i + 1}: Use for ${ref.role.toUpperCase()}</span>`);
          textParts.push(`Image ${i + 1}: Use for ${ref.role.toUpperCase()}`);
        });
        htmlParts.push(''); textParts.push('');
      }
      
      categories.forEach(cat => {
        const phrases = slots[cat.id] || [];
        if (phrases.length > 0) {
          const colored = phrases.map(p => `<span class="preview-phrase" style="color: ${cat.color}">${escapeHTML(p)}</span>`);
          const baseLabelLower = cat.label.toLowerCase().replace(/\s*\(\d+\)$/, '');
          
          if (baseLabelLower.includes('constraint')) {
            htmlParts.push(`\n${colored.join('\n')}`);
            textParts.push(`\n${phrases.join('\n')}`);
          } else if (['lighting', 'camera', 'style', 'mood', 'quality', 'color'].some(k => baseLabelLower.includes(k))) {
            htmlParts.push(`<span class="preview-label">${cat.label}:</span> ${colored.join('<span class="preview-sep">; </span>')}`);
            textParts.push(`${cat.label}: ${phrases.join('; ')}`);
          } else {
            htmlParts.push(colored.join('<span class="preview-sep">, </span>'));
            textParts.push(phrases.join(', '));
          }
        }
      });
      
      const isEmpty = !categories.some(c => slots[c.id]?.length > 0) && activeRefs.length === 0;
      preview.innerHTML = isEmpty ? '<span class="empty">Start adding phrases to build your prompt...</span>' : htmlParts.join('\n');
      preview.dataset.plainText = textParts.join('\n').trim();
      preview.className = `preview-content ${isEmpty ? 'empty' : ''}`;
      copyBtn.disabled = isEmpty;
    }
    
    function renderTemplateSelect() {
      const select = document.getElementById('templateSelect');
      select.innerHTML = '<option value=""> Load...</option>';
      templates.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.name;
        opt.textContent = t.name;
        select.appendChild(opt);
      });
    }
    
    // ============ FOLDER / PHRASE MANAGEMENT ============
    function toggleCategory(id) {
      if (isDragging) return;
      expandedCategory = expandedCategory === id ? null : id;
      renderLibrary();
    }
    
    function deletePhrase(catId, idx) {
      if (!library[catId]) return;
      library[catId].splice(idx, 1);
      saveToStorage();
      renderLibrary();
    }
    
    function removeFromSlot(catId, idx) {
      if (!slots[catId]) return;
      slots[catId].splice(idx, 1);
      renderSlots();
      renderPreview();
    }
    
    function clearAllSlots() {
      categories.forEach(c => slots[c.id] = []);
      currentTemplateName = '';
      document.getElementById('templateCurrent').textContent = ' Untitled Prompt';
      renderSlots();
      renderPreview();
    }
    
    function showAddForm(catId) {
      document.getElementById(`addForm-${catId}`).classList.add('active');
      document.getElementById(`addBtn-${catId}`).style.display = 'none';
      document.querySelector(`#addForm-${catId} input`).focus();
    }
    
    function hideAddForm(catId) {
      document.getElementById(`addForm-${catId}`).classList.remove('active');
      document.getElementById(`addBtn-${catId}`).style.display = 'block';
      document.querySelector(`#addForm-${catId} input`).value = '';
    }
    
    function handleAddKeydown(e, catId) {
      if (e.key === 'Enter') addPhraseFromForm(catId);
      if (e.key === 'Escape') hideAddForm(catId);
    }
    
    function addPhraseFromForm(catId) {
      const input = document.querySelector(`#addForm-${catId} input`);
      const phrase = input.value.trim();
      if (phrase) {
        if (!library[catId]) library[catId] = [];
        library[catId].push(phrase);
        saveToStorage();
        input.value = '';
        renderLibrary();
        showToast('Phrase added!');
      }
    }
    
    function openFolderModal() {
      document.getElementById('folderModal').classList.add('active');
      document.getElementById('newFolderName').focus();
      selectedEmoji = '';
      updateEmojiSelection();
    }
    
    function closeFolderModal() {
      document.getElementById('folderModal').classList.remove('active');
      document.getElementById('newFolderName').value = '';
    }
    
    function updateEmojiSelection() {
      document.querySelectorAll('.emoji-option').forEach(o => o.classList.toggle('selected', o.dataset.emoji === selectedEmoji));
    }
    
    function createNewFolder() {
      const name = document.getElementById('newFolderName').value.trim();
      if (!name) { showToast('Enter a folder name'); return; }
      const id = 'custom_' + Date.now();
      const color = COLOR_PALETTE[Math.floor(Math.random() * COLOR_PALETTE.length)];
      categories.push({ id, label: name, icon: selectedEmoji, color });
      library[id] = [];
      slots[id] = [];
      saveToStorage();
      closeFolderModal();
      renderLibrary();
      renderSlots();
      showToast(`Folder "${name}" created!`);
    }
    
    function duplicateFolder(catId) {
      const src = categories.find(c => c.id === catId);
      if (!src) return;
      const newId = 'dup_' + Date.now();
      let baseLabel = src.label.replace(/\s*\(\d+\)$/, '');
      let counter = 2;
      let newLabel = `${baseLabel} (${counter})`;
      while (categories.some(c => c.label === newLabel)) { counter++; newLabel = `${baseLabel} (${counter})`; }
      const srcIdx = categories.findIndex(c => c.id === catId);
      categories.splice(srcIdx + 1, 0, { id: newId, label: newLabel, icon: src.icon, color: src.color });
      library[newId] = [...(library[catId] || [])];
      slots[newId] = [];
      saveToStorage();
      renderLibrary();
      renderSlots();
      showToast(`Folder duplicated as "${newLabel}"`);
    }
    
    function renameFolder(catId) {
      const cat = categories.find(c => c.id === catId);
      if (!cat) return;
      const newName = prompt('Rename folder:', cat.label);
      if (newName && newName.trim() && newName.trim() !== cat.label) {
        cat.label = newName.trim();
        saveToStorage();
        renderLibrary();
        renderSlots();
        renderPreview();
        showToast(`Renamed to "${newName.trim()}"`);
      }
    }
    
    function deleteFolder(catId) {
      const cat = categories.find(c => c.id === catId);
      if (!cat || !confirm(`Delete folder "${cat.label}"?`)) return;
      categories = categories.filter(c => c.id !== catId);
      delete library[catId];
      delete slots[catId];
      saveToStorage();
      renderLibrary();
      renderSlots();
      renderPreview();
      showToast('Folder deleted');
    }
    
    // ============ COLOR PICKER ============
    function openColorPicker(catId) {
      activeColorPicker = catId;
      const cat = categories.find(c => c.id === catId);
      const grid = document.getElementById('colorPickerGrid');
      grid.innerHTML = COLOR_PALETTE.map(c => `
        <div class="color-option ${cat && cat.color === c ? 'selected' : ''}" style="background: ${c}" data-color="${c}"></div>
      `).join('');
      document.getElementById('colorPickerOverlay').classList.add('active');
      document.getElementById('colorPickerModal').classList.add('active');
    }
    
    function closeColorPicker() {
      activeColorPicker = null;
      document.getElementById('colorPickerOverlay').classList.remove('active');
      document.getElementById('colorPickerModal').classList.remove('active');
    }
    
    function setFolderColor(catId, color) {
      const cat = categories.find(c => c.id === catId);
      if (cat) {
        cat.color = color;
        saveToStorage();
        renderLibrary();
        renderSlots();
        renderPreview();
        document.querySelectorAll('#colorPickerGrid .color-option').forEach(o => o.classList.toggle('selected', o.dataset.color === color));
      }
    }
    
    // ============ REFERENCE IMAGES ============
    function handleImageSelect(e) {
      const file = e.target.files[0];
      if (!file || activeImageSlot === null) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        references[activeImageSlot].image = ev.target.result;
        renderReferences();
        renderPreview();
        showToast('Image added!');
        activeImageSlot = null;
      };
      reader.readAsDataURL(file);
      e.target.value = '';
    }
    
    function removeRefImage(idx) {
      references[idx].image = null;
      renderReferences();
      renderPreview();
    }
    
    function changeRefRole(idx, role) {
      references[idx].role = role;
      renderPreview();
    }
    
    // ============ BLUEPRINTS ============
    function getAllBlueprints() { return [...DEFAULT_BLUEPRINTS, ...customBlueprints]; }
    
    function openBlueprintModal() {
      renderBlueprintGrid();
      document.getElementById('blueprintOverlay').classList.add('active');
      document.getElementById('blueprintModal').classList.add('active');
    }
    
    function closeBlueprintModal() {
      document.getElementById('blueprintOverlay').classList.remove('active');
      document.getElementById('blueprintModal').classList.remove('active');
    }
    
    function renderBlueprintGrid() {
      const grid = document.getElementById('blueprintGrid');
      const all = getAllBlueprints();
      
      // Start Blank card
      let html = `
        <div class="blueprint-card blank-blueprint" data-blueprint-id="blank">
          <div class="blueprint-card-header">
            <span class="blueprint-icon"></span>
            <span class="blueprint-name">Start Blank</span>
          </div>
          <div class="blueprint-description">Empty canvas to build custom structure</div>
          <div class="blueprint-meta">0 folders</div>
          ${currentBlueprintId === 'blank' ? '<div class="blueprint-active-badge">Active</div>' : ''}
        </div>
      `;
      
      html += all.map(bp => {
        const isActive = bp.id === currentBlueprintId;
        const isCustom = customBlueprints.some(c => c.id === bp.id);
        return `
          <div class="blueprint-card ${isActive ? 'active' : ''}" data-blueprint-id="${bp.id}">
            <div class="blueprint-card-header">
              <span class="blueprint-icon">${bp.icon}</span>
              <span class="blueprint-name">${bp.name}</span>
              <button class="blueprint-export-btn" data-blueprint-id="${bp.id}" title="Export"></button>
              ${isCustom ? `<button class="blueprint-delete-btn" data-blueprint-id="${bp.id}"></button>` : ''}
            </div>
            <div class="blueprint-description">${bp.description}</div>
            <div class="blueprint-meta">${bp.categories.length} folders</div>
            ${isActive ? '<div class="blueprint-active-badge">Active</div>' : ''}
          </div>
        `;
      }).join('');
      
      grid.innerHTML = html;
    }
    
    function loadBlueprint(bpId) {
      if (bpId === 'blank') {
        startBlankBlueprint();
        return;
      }
      const bp = getAllBlueprints().find(b => b.id === bpId);
      if (!bp) return;
      const hasWork = categories.some(c => slots[c.id]?.length > 0);
      if (hasWork && !confirm(`Loading "${bp.name}" will clear your current prompt. Continue?`)) return;
      
      categories = bp.categories.map(c => ({...c}));
      currentBlueprintId = bpId;
      categories.forEach(c => {
        if (!library[c.id]) library[c.id] = DEFAULT_PHRASES[c.id] ? [...DEFAULT_PHRASES[c.id]] : [];
      });
      slots = {};
      categories.forEach(c => slots[c.id] = []);
      expandedCategory = null;
      
      saveToStorage();
      renderLibrary();
      renderSlots();
      renderPreview();
      renderBlueprintGrid();
      updateBlueprintButton();
      closeBlueprintModal();
      showToast(`Loaded "${bp.name}" blueprint`);
    }
    
    function startBlankBlueprint() {
      const hasWork = categories.some(c => slots[c.id]?.length > 0);
      if (hasWork && !confirm('Starting blank will clear your current prompt. Continue?')) return;
      
      currentBlueprintId = 'blank';
      categories = [];
      slots = {};
      expandedCategory = null;
      
      saveToStorage();
      renderLibrary();
      renderSlots();
      renderPreview();
      renderBlueprintGrid();
      updateBlueprintButton();
      closeBlueprintModal();
      showToast("Blank canvas! Use '+ Add New Folder' to build.");
    }
    
    function saveCurrentAsBlueprint() {
      const name = prompt('Name your blueprint:');
      if (!name || !name.trim()) return;
      const icon = prompt('Choose an icon (emoji):', '') || '';
      const desc = prompt('Short description:', 'Custom blueprint') || 'Custom blueprint';
      const id = 'custom_' + Date.now();
      customBlueprints.push({ id, name: name.trim(), icon, description: desc, categories: categories.map(c => ({...c})) });
      currentBlueprintId = id;
      saveToStorage();
      renderBlueprintGrid();
      updateBlueprintButton();
      showToast(`Blueprint "${name.trim()}" saved!`);
    }
    
    function deleteBlueprint(bpId) {
      const bp = customBlueprints.find(b => b.id === bpId);
      if (!bp || !confirm(`Delete blueprint "${bp.name}"?`)) return;
      customBlueprints = customBlueprints.filter(b => b.id !== bpId);
      if (currentBlueprintId === bpId) currentBlueprintId = 'portrait';
      saveToStorage();
      renderBlueprintGrid();
      updateBlueprintButton();
      showToast('Blueprint deleted');
    }
    
    function exportBlueprint(bpId) {
      const bp = getAllBlueprints().find(b => b.id === bpId);
      if (!bp) return;
      const phrases = {};
      bp.categories.forEach(c => phrases[c.id] = library[c.id] || DEFAULT_PHRASES[c.id] || []);
      const data = { version: 1, type: 'prompt-blocks-blueprint', blueprint: bp, phrases };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `blueprint-${bp.name.toLowerCase().replace(/\s+/g, '-')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast(`Exported "${bp.name}"`);
    }
    
    function triggerBlueprintImport() { document.getElementById('blueprintFileInput').click(); }
    
    function handleBlueprintImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          if (data.type !== 'prompt-blocks-blueprint' || !data.blueprint) {
            showToast('Invalid blueprint file');
            return;
          }
          let newName = data.blueprint.name;
          let counter = 1;
          while (getAllBlueprints().some(b => b.name === newName)) { counter++; newName = `${data.blueprint.name} (${counter})`; }
          const newBp = { id: 'imported_' + Date.now(), name: newName, icon: data.blueprint.icon || '', description: data.blueprint.description || 'Imported', categories: data.blueprint.categories };
          customBlueprints.push(newBp);
          if (data.phrases) {
            Object.keys(data.phrases).forEach(id => {
              if (!library[id]) library[id] = [];
              data.phrases[id].forEach(p => { if (!library[id].includes(p)) library[id].push(p); });
            });
          }
          saveToStorage();
          renderBlueprintGrid();
          showToast(`Imported "${newName}"`);
        } catch (err) {
          showToast('Error reading file');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    }
    
    function updateBlueprintButton() {
      const btn = document.getElementById('blueprintBtn');
      if (currentBlueprintId === 'blank') {
        btn.textContent = ' Blank';
        return;
      }
      const bp = getAllBlueprints().find(b => b.id === currentBlueprintId);
      if (bp) btn.textContent = `${bp.icon} ${bp.name}`;
    }
    
    // ============ TEXT BLUEPRINT IMPORT ============
    function triggerTextBlueprintImport() {
      closeBlueprintModal();
      document.getElementById('importTextOverlay').classList.add('active');
      document.getElementById('importTextModal').classList.add('active');
    }
    
    function closeImportTextModal() {
      document.getElementById('importTextOverlay').classList.remove('active');
      document.getElementById('importTextModal').classList.remove('active');
      document.getElementById('importTextArea').value = '';
    }
    
    function parseAndImportTextBlueprint() {
      let text = document.getElementById('importTextArea').value.trim();
      if (!text) { showToast('Paste blueprint text first'); return; }
      
      // Auto-decode URL-encoded text (iOS paste bug workaround)
      if (text.includes('%20') || text.includes('%0A')) {
        try {
          text = decodeURIComponent(text);
        } catch (e) {
          // If decode fails, try replacing common encodings manually
          text = text.replace(/%20/g, ' ').replace(/%0A/g, '\n').replace(/%3A/g, ':').replace(/%7C/g, '|').replace(/%23/g, '#');
        }
      }
      
      try {
        const result = parseTextBlueprint(text);
        if (!result.name) { showToast('Could not find BLUEPRINT: name'); return; }
        if (result.categories.length === 0) { showToast('No FOLDER: sections found'); return; }
        
        // Check for duplicate name
        let finalName = result.name;
        let counter = 1;
        while (getAllBlueprints().some(b => b.name === finalName)) { counter++; finalName = `${result.name} (${counter})`; }
        
        const newBp = {
          id: 'text_' + Date.now(),
          name: finalName,
          icon: result.icon || '',
          description: result.description || 'Imported from text',
          categories: result.categories
        };
        
        customBlueprints.push(newBp);
        
        // Add phrases to library
        result.categories.forEach(cat => {
          if (!library[cat.id]) library[cat.id] = [];
          (result.phrases[cat.id] || []).forEach(p => {
            if (!library[cat.id].includes(p)) library[cat.id].push(p);
          });
        });
        
        saveToStorage();
        closeImportTextModal();
        renderBlueprintGrid();
        openBlueprintModal();
        showToast(`Imported "${finalName}"!`);
        
      } catch (err) {
        console.error(err);
        showToast('Error parsing text format');
      }
    }
    
    function parseTextBlueprint(text) {
      const lines = text.split('\n').map(l => l.trim());
      const result = { name: '', icon: '', description: '', categories: [], phrases: {} };
      
      let currentFolder = null;
      
      for (const line of lines) {
        if (line.startsWith('BLUEPRINT:')) {
          result.name = line.replace('BLUEPRINT:', '').trim();
        } else if (line.startsWith('ICON:')) {
          result.icon = line.replace('ICON:', '').trim();
        } else if (line.startsWith('DESCRIPTION:')) {
          result.description = line.replace('DESCRIPTION:', '').trim();
        } else if (line.startsWith('FOLDER:')) {
          // Parse: FOLDER: Name | Icon | #Color
          const folderDef = line.replace('FOLDER:', '').trim();
          const parts = folderDef.split('|').map(p => p.trim());
          const name = parts[0] || 'Unnamed';
          const icon = parts[1] || '';
          const color = parts[2] || COLOR_PALETTE[result.categories.length % COLOR_PALETTE.length];
          const id = 'txt_' + Date.now() + '_' + result.categories.length;
          
          currentFolder = { id, label: name, icon, color };
          result.categories.push(currentFolder);
          result.phrases[id] = [];
        } else if (line.startsWith('-') && currentFolder) {
          const phrase = line.replace(/^-\s*/, '').trim();
          if (phrase) result.phrases[currentFolder.id].push(phrase);
        }
      }
      
      return result;
    }
    
    // Export current as text format
    function exportAsTextBlueprint() {
      const bp = getAllBlueprints().find(b => b.id === currentBlueprintId);
      const name = bp ? bp.name : 'Custom Blueprint';
      const icon = bp ? bp.icon : '';
      const desc = bp ? bp.description : 'Exported blueprint';
      
      let text = `BLUEPRINT: ${name}\nICON: ${icon}\nDESCRIPTION: ${desc}\n\n`;
      
      categories.forEach(cat => {
        text += `FOLDER: ${cat.label} | ${cat.icon} | ${cat.color}\n`;
        const phrases = library[cat.id] || [];
        phrases.forEach(p => text += `- ${p}\n`);
        text += '\n';
      });
      
      return text.trim();
    }
    
    // ============ ADD FOLDER FROM BLUEPRINT ============
    function openAddFolderModal() {
      renderAddFolderGrid();
      document.getElementById('addFolderOverlay').classList.add('active');
      document.getElementById('addFolderModal').classList.add('active');
    }
    
    function closeAddFolderModal() {
      document.getElementById('addFolderOverlay').classList.remove('active');
      document.getElementById('addFolderModal').classList.remove('active');
    }
    
    function renderAddFolderGrid() {
      const grid = document.getElementById('addFolderGrid');
      const currentIds = categories.map(c => c.id);
      const byBlueprint = {};
      
      getAllBlueprints().forEach(bp => {
        byBlueprint[bp.id] = { name: bp.name, icon: bp.icon, folders: bp.categories.filter(c => !currentIds.includes(c.id)) };
      });
      
      let html = '';
      Object.keys(byBlueprint).forEach(bpId => {
        const bp = byBlueprint[bpId];
        if (bp.folders.length === 0) return;
        html += `
          <div class="add-folder-blueprint-section">
            <div class="add-folder-blueprint-title">${bp.icon} ${bp.name}</div>
            <div class="add-folder-list">
              ${bp.folders.map(f => `
                <div class="add-folder-item" data-folder-id="${f.id}" data-label="${escapeHTML(f.label)}" data-icon="${f.icon}" data-color="${f.color}">
                  <span class="add-folder-item-icon">${f.icon}</span>
                  <span class="add-folder-item-label">${f.label}</span>
                  ${DEFAULT_PHRASES[f.id] ? `<span class="add-folder-item-badge">${DEFAULT_PHRASES[f.id].length}</span>` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
      grid.innerHTML = html || '<div style="color:#666;text-align:center;padding:40px;">All folders already in your structure.</div>';
    }
    
    function addFolderFromBlueprint(folderId, label, icon, color) {
      if (categories.some(c => c.id === folderId)) { showToast('Folder already exists'); return; }
      categories.push({ id: folderId, label, icon, color });
      if (DEFAULT_PHRASES[folderId] && !library[folderId]) library[folderId] = [...DEFAULT_PHRASES[folderId]];
      if (!library[folderId]) library[folderId] = [];
      slots[folderId] = [];
      saveToStorage();
      renderLibrary();
      renderSlots();
      renderAddFolderGrid();
      showToast(`Added "${label}" folder`);
    }
    
    // ============ TEMPLATES ============
    function showSaveForm() {
      document.getElementById('saveForm').classList.add('active');
      document.getElementById('saveBtn').style.display = 'none';
      document.getElementById('saveNameInput').focus();
    }
    
    function hideSaveForm() {
      document.getElementById('saveForm').classList.remove('active');
      document.getElementById('saveBtn').style.display = 'block';
      document.getElementById('saveNameInput').value = '';
    }
    
    function saveTemplate() {
      const name = document.getElementById('saveNameInput').value.trim();
      if (!name) return;
      templates = templates.filter(t => t.name !== name);
      templates.push({ name, slots: JSON.parse(JSON.stringify(slots)), references: references.map(r => ({ image: null, role: r.role })) });
      currentTemplateName = name;
      document.getElementById('templateCurrent').textContent = ` ${name}`;
      saveToStorage();
      renderTemplateSelect();
      hideSaveForm();
      showToast('Template saved!');
    }
    
    function loadTemplate(name) {
      if (!name) return;
      const t = templates.find(x => x.name === name);
      if (!t) return;
      slots = JSON.parse(JSON.stringify(t.slots));
      categories.forEach(c => { if (!slots[c.id]) slots[c.id] = []; });
      if (t.references) references = t.references.map(r => ({ image: null, role: r.role }));
      currentTemplateName = name;
      document.getElementById('templateCurrent').textContent = ` ${name}`;
      document.getElementById('templateSelect').value = '';
      renderSlots();
      renderReferences();
      renderPreview();
    }
    
    // ============ COPY ============
    function copyPrompt() {
      const preview = document.getElementById('previewContent');
      const copyBtn = document.getElementById('copyBtn');
      const text = preview.dataset.plainText || preview.textContent;
      
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          showToast(' Copied to clipboard!');
          animateCopyButton(copyBtn);
        }).catch(() => fallbackCopy(text, copyBtn));
      } else {
        fallbackCopy(text, copyBtn);
      }
    }
    
    function fallbackCopy(text, btn) {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.cssText = 'position:fixed;left:-9999px;top:0';
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, text.length);
      try { document.execCommand('copy'); showToast(' Copied!'); animateCopyButton(btn); }
      catch (e) { showToast(' Could not copy'); }
      document.body.removeChild(ta);
    }
    
    function animateCopyButton(btn) {
      btn.textContent = ' Copied!';
      btn.classList.add('copied');
      setTimeout(() => { btn.textContent = ' Copy'; btn.classList.remove('copied'); }, 2000);
    }
    
    // ============ FULLSCREEN ============
    function toggleFullscreen() {
      if (!document.fullscreenElement && !document.webkitFullscreenElement) {
        const el = document.documentElement;
        if (el.requestFullscreen) el.requestFullscreen();
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      } else {
        if (document.exitFullscreen) document.exitFullscreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      }
    }
    
    // ============ DRAG SYSTEM ============
    function initDragSystem() {
      dragGhost = document.getElementById('dragGhost');
      document.addEventListener('contextmenu', e => {
        if (e.target.closest('.phrase-chip') || e.target.closest('.category-header')) e.preventDefault();
      });
      document.addEventListener('touchmove', handleDragMove, { passive: false });
      document.addEventListener('touchend', handleDragEnd);
      document.addEventListener('touchcancel', handleDragEnd);
      document.addEventListener('mousemove', handleDragMove);
      document.addEventListener('mouseup', handleDragEnd);
    }
    
    function attachChipListeners(chip) {
      chip.addEventListener('touchstart', handleTouchStart, { passive: false });
      chip.addEventListener('mousedown', handleMouseDown);
    }
    
    function attachFolderListeners(header) {
      header.addEventListener('touchstart', handleFolderTouchStart, { passive: false });
      header.addEventListener('mousedown', handleFolderMouseDown);
    }
    
    function handleTouchStart(e) {
      const chip = e.target.closest('.phrase-chip');
      if (!chip || chip.classList.contains('in-slot') || e.target.closest('.phrase-delete')) return;
      const touch = e.touches[0];
      touchStartPos = { x: touch.clientX, y: touch.clientY };
      pressStartChip = chip;
      chip.classList.add('pressing');
      pressTimer = setTimeout(() => {
        if (editMode) startEditPhraseDrag(chip, touch.clientX, touch.clientY);
        else startDrag(chip, touch.clientX, touch.clientY);
      }, 250);
    }
    
    function handleMouseDown(e) {
      const chip = e.target.closest('.phrase-chip');
      if (!chip || chip.classList.contains('in-slot') || e.target.closest('.phrase-delete')) return;
      touchStartPos = { x: e.clientX, y: e.clientY };
      pressStartChip = chip;
      chip.classList.add('pressing');
      pressTimer = setTimeout(() => {
        if (editMode) startEditPhraseDrag(chip, e.clientX, e.clientY);
        else startDrag(chip, e.clientX, e.clientY);
      }, 250);
    }
    
    function handleFolderTouchStart(e) {
      if (!editMode) return;
      const header = e.target.closest('.category-header');
      if (!header) return;
      e.preventDefault();
      e.stopPropagation();
      const touch = e.touches[0];
      touchStartPos = { x: touch.clientX, y: touch.clientY };
      pressTimer = setTimeout(() => startFolderDrag(header, touch.clientX, touch.clientY), 250);
    }
    
    function handleFolderMouseDown(e) {
      if (!editMode) return;
      const header = e.target.closest('.category-header');
      if (!header) return;
      touchStartPos = { x: e.clientX, y: e.clientY };
      pressTimer = setTimeout(() => startFolderDrag(header, e.clientX, e.clientY), 250);
    }
    
    function startDrag(chip, x, y) {
      isDragging = true;
      editDragType = null;
      const phrase = chip.dataset.phrase;
      const catId = chip.dataset.category;
      dragData = { phrase, categoryId: catId, sourceChip: chip };
      chip.classList.remove('pressing');
      chip.classList.add('picked-up');
      dragGhost.textContent = phrase.length > 25 ? phrase.substring(0, 25) + '...' : phrase;
      dragGhost.style.display = 'block';
      dragGhost.style.left = x + 'px';
      dragGhost.style.top = y + 'px';
      highlightValidSlots(catId);
      if (navigator.vibrate) navigator.vibrate(50);
    }
    
    function startEditPhraseDrag(chip, x, y) {
      isDragging = true;
      editDragType = 'phrase';
      const phrase = chip.dataset.phrase;
      const catId = chip.dataset.category;
      const idx = parseInt(chip.dataset.index);
      editDragData = { phrase, categoryId: catId, index: idx, sourceChip: chip };
      chip.classList.remove('pressing');
      chip.classList.add('picked-up');
      dragGhost.textContent = phrase.length > 25 ? phrase.substring(0, 25) + '...' : phrase;
      dragGhost.style.display = 'block';
      dragGhost.style.left = x + 'px';
      dragGhost.style.top = y + 'px';
      if (navigator.vibrate) navigator.vibrate(50);
    }
    
    function startFolderDrag(header, x, y) {
      isDragging = true;
      editDragType = 'folder';
      const folderId = header.dataset.folderId;
      const cat = categories.find(c => c.id === folderId);
      editDragData = { folderId, sourceHeader: header };
      header.classList.add('dragging-folder');
      dragGhost.textContent = ` ${cat ? cat.label : 'Folder'}`;
      dragGhost.style.display = 'block';
      dragGhost.style.left = x + 'px';
      dragGhost.style.top = y + 'px';
      if (navigator.vibrate) navigator.vibrate(50);
    }
    
    function handleDragMove(e) {
      if (pressTimer && !isDragging) {
        const pos = e.touches ? e.touches[0] : e;
        if (Math.abs(pos.clientX - touchStartPos.x) > 10 || Math.abs(pos.clientY - touchStartPos.y) > 10) cancelPress();
        return;
      }
      if (!isDragging) return;
      e.preventDefault();
      const pos = e.touches ? e.touches[0] : e;
      dragGhost.style.left = pos.clientX + 'px';
      dragGhost.style.top = pos.clientY + 'px';
      if (editMode && editDragType) updateEditDropTarget(pos.clientX, pos.clientY);
      else updateDropTarget(pos.clientX, pos.clientY);
    }
    
    function handleDragEnd(e) {
      cancelPress();
      if (!isDragging) return;
      const pos = e.changedTouches ? e.changedTouches[0] : e;
      if (editMode && editDragType) handleEditDragEnd(pos.clientX, pos.clientY);
      else handleNormalDragEnd(pos.clientX, pos.clientY);
    }
    
    function handleNormalDragEnd(x, y) {
      const dropTarget = getDropTarget(x, y);
      if (dropTarget && dropTarget.categoryId === dragData.categoryId) {
        if (!slots[dragData.categoryId]) slots[dragData.categoryId] = [];
        if (!slots[dragData.categoryId].includes(dragData.phrase)) {
          slots[dragData.categoryId].push(dragData.phrase);
          dragGhost.classList.add('dropping');
          setTimeout(() => { renderSlots(); renderPreview(); cleanupDrag(); }, 150);
        } else cleanupDrag();
      } else if (dropTarget && dropTarget.categoryId !== dragData.categoryId) {
        dropTarget.element.classList.add('invalid-drop');
        setTimeout(() => dropTarget.element.classList.remove('invalid-drop'), 300);
        cleanupDrag();
      } else cleanupDrag();
    }
    
    function handleEditDragEnd(x, y) {
      const trashRect = document.getElementById('trashBinTarget').getBoundingClientRect();
      if (x >= trashRect.left && x <= trashRect.right && y >= trashRect.top && y <= trashRect.bottom) {
        if (editDragType === 'phrase') {
          library[editDragData.categoryId].splice(editDragData.index, 1);
          showToast('Phrase deleted');
        } else if (editDragType === 'folder') {
          const cat = categories.find(c => c.id === editDragData.folderId);
          if (cat && confirm(`Delete folder "${cat.label}"?`)) {
            categories = categories.filter(c => c.id !== editDragData.folderId);
            delete library[editDragData.folderId];
            delete slots[editDragData.folderId];
            showToast('Folder deleted');
          }
        }
        saveToStorage();
        renderLibrary();
        renderSlots();
        renderPreview();
        cleanupDrag();
        return;
      }
      
      if (editDragType === 'folder') {
        dragGhost.style.display = 'none';
        const el = document.elementFromPoint(x, y);
        dragGhost.style.display = 'block';
        const targetCat = el?.closest('.library-category');
        if (targetCat && targetCat.dataset.categoryId !== editDragData.folderId) {
          const srcIdx = categories.findIndex(c => c.id === editDragData.folderId);
          const tgtIdx = categories.findIndex(c => c.id === targetCat.dataset.categoryId);
          if (srcIdx !== -1 && tgtIdx !== -1) {
            const [removed] = categories.splice(srcIdx, 1);
            categories.splice(tgtIdx, 0, removed);
            saveToStorage();
            renderLibrary();
            renderSlots();
            renderPreview();
          }
        }
      }
      cleanupDrag();
    }
    
    function cancelPress() {
      if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; }
      if (pressStartChip) { pressStartChip.classList.remove('pressing'); pressStartChip = null; }
    }
    
    function cleanupDrag() {
      isDragging = false;
      editDragType = null;
      editDragData = null;
      dragGhost.style.display = 'none';
      dragGhost.classList.remove('dropping');
      if (dragData && dragData.sourceChip) dragData.sourceChip.classList.remove('picked-up');
      document.querySelectorAll('.prompt-slot').forEach(s => s.classList.remove('drag-hover', 'tap-ready'));
      document.querySelectorAll('.category-header').forEach(h => h.classList.remove('dragging-folder'));
      document.querySelectorAll('.library-category').forEach(c => c.classList.remove('drag-over-folder'));
      document.getElementById('trashBinTarget')?.classList.remove('drag-over');
      dragData = null;
    }
    
    function highlightValidSlots(catId) {
      document.querySelectorAll('.prompt-slot').forEach(s => {
        if (s.dataset.category === catId) s.classList.add('tap-ready');
      });
    }
    
    function updateDropTarget(x, y) {
      document.querySelectorAll('.prompt-slot.drag-hover').forEach(s => s.classList.remove('drag-hover'));
      const target = getDropTarget(x, y);
      if (target && dragData && target.categoryId === dragData.categoryId) target.element.classList.add('drag-hover');
    }
    
    function updateEditDropTarget(x, y) {
      document.querySelectorAll('.drag-over-folder').forEach(el => el.classList.remove('drag-over-folder'));
      const trashTarget = document.getElementById('trashBinTarget');
      const trashRect = trashTarget.getBoundingClientRect();
      if (x >= trashRect.left && x <= trashRect.right && y >= trashRect.top && y <= trashRect.bottom) {
        trashTarget.classList.add('drag-over');
      } else {
        trashTarget.classList.remove('drag-over');
        if (editDragType === 'folder') {
          dragGhost.style.display = 'none';
          const el = document.elementFromPoint(x, y);
          dragGhost.style.display = 'block';
          const targetCat = el?.closest('.library-category');
          if (targetCat && targetCat.dataset.categoryId !== editDragData.folderId) {
            targetCat.classList.add('drag-over-folder');
          }
        }
      }
    }
    
    function getDropTarget(x, y) {
      dragGhost.style.display = 'none';
      const el = document.elementFromPoint(x, y);
      dragGhost.style.display = 'block';
      if (!el) return null;
      const slot = el.closest('.prompt-slot');
      return slot ? { element: slot, categoryId: slot.dataset.category } : null;
    }
    
    // ============ CLAUDE ASSISTANT ============
    function getApiKey() { return localStorage.getItem('claudeApiKey') || ''; }
    
    function saveApiKey() {
      const key = document.getElementById('apiKeyInput').value.trim();
      if (!key) { showToast('Enter an API key'); return; }
      if (!key.startsWith('sk-ant-')) { showToast('Key should start with sk-ant-'); return; }
      localStorage.setItem('claudeApiKey', key);
      document.getElementById('apiKeyInput').value = '';
      updateAssistantUI();
      showToast('API key saved!');
    }
    
    function toggleAssistant() {
      assistantActive = !assistantActive;
      const panel = document.getElementById('previewPanel');
      const chatBtn = document.getElementById('chatToggleBtn');
      const previewContent = document.getElementById('previewContent');
      const templateBar = document.getElementById('templateBar');
      const assistantPanel = document.getElementById('assistantPanel');
      const copyBtn = document.getElementById('copyBtn');
      const previewTitle = document.getElementById('previewTitle');
      
      if (assistantActive) {
        chatBtn.classList.add('active');
        chatBtn.textContent = ' Preview';
        previewContent.style.display = 'none';
        templateBar.style.display = 'none';
        assistantPanel.classList.add('active');
        copyBtn.style.display = 'none';
        previewTitle.textContent = ' Claude Assistant';
        updateAssistantUI();
      } else {
        chatBtn.classList.remove('active');
        chatBtn.textContent = ' Assistant';
        previewContent.style.display = 'block';
        templateBar.style.display = 'flex';
        assistantPanel.classList.remove('active');
        copyBtn.style.display = 'block';
        previewTitle.textContent = ' Generated Prompt';
      }
    }
    
    function updateAssistantUI() {
      const hasKey = !!getApiKey();
      document.getElementById('apiKeySetup').style.display = hasKey ? 'none' : 'flex';
      document.getElementById('assistantMessages').style.display = hasKey ? 'flex' : 'none';
      document.getElementById('assistantInputArea').style.display = hasKey ? 'block' : 'none';
    }
    
    function useCurrentPrompt() {
      const preview = document.getElementById('previewContent');
      const text = preview.dataset.plainText || preview.textContent;
      if (text && !text.includes('Start adding phrases')) {
        document.getElementById('assistantInput').value = text;
        showToast('Current prompt loaded');
      } else showToast('Build a prompt first!');
    }
    
    function clearChat() {
      chatHistory = [];
      document.getElementById('assistantMessages').innerHTML = `
        <div class="assistant-message system">Paste your prompt idea or describe what you're trying to create. I'll help you improve it!</div>
      `;
      updateSuggestions();
    }
    
    function addMessage(role, content, isError = false) {
      const container = document.getElementById('assistantMessages');
      const div = document.createElement('div');
      div.className = `assistant-message ${role}${isError ? ' error' : ''}`;
      
      if (role === 'assistant' && !isError) {
        // Check for blueprint format first
        const blueprintData = detectBlueprintInContent(content);
        
        if (blueprintData) {
          // Show explanation text if any
          const beforeBlueprint = content.split('BLUEPRINT:')[0].trim();
          const afterBlueprint = content.split(/```\s*$/)[1]?.trim() || '';
          
          let html = '';
          if (beforeBlueprint) html += `<p>${escapeHTML(beforeBlueprint)}</p>`;
          
          // Create the blueprint preview card
          html += createBlueprintPreviewCard(blueprintData);
          
          if (afterBlueprint) html += `<p>${escapeHTML(afterBlueprint)}</p>`;
          
          div.innerHTML = html;
        } else {
          // Check for regular code block (improved prompt)
          const promptMatch = content.match(/```(?:prompt)?\n?([\s\S]*?)```/);
          if (promptMatch) {
            const improvedPrompt = promptMatch[1].trim();
            const explanation = content.replace(promptMatch[0], '').trim();
            div.innerHTML = `
              ${explanation ? `<p>${escapeHTML(explanation)}</p>` : ''}
              <pre>${escapeHTML(improvedPrompt)}</pre>
              <button class="copy-suggestion" onclick="copySuggestion(this)"> Copy improved prompt</button>
            `;
          } else {
            div.innerHTML = `<p>${escapeHTML(content)}</p>`;
          }
        }
      } else {
        div.textContent = content;
      }
      
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      
      // Update suggestions based on context
      updateSuggestions();
    }
    
    function detectBlueprintInContent(content) {
      // Look for blueprint format
      if (!content.includes('BLUEPRINT:') || !content.includes('FOLDER:')) {
        return null;
      }
      
      // Extract the blueprint text (might be in a code block or plain)
      let blueprintText = content;
      const codeBlockMatch = content.match(/```[\s\S]*?(BLUEPRINT:[\s\S]*?)```/);
      if (codeBlockMatch) {
        blueprintText = codeBlockMatch[1];
      } else if (content.includes('BLUEPRINT:')) {
        // Find the blueprint section
        const startIdx = content.indexOf('BLUEPRINT:');
        blueprintText = content.substring(startIdx);
      }
      
      // Parse it
      try {
        const parsed = parseTextBlueprint(blueprintText);
        if (parsed.name && parsed.categories.length > 0) {
          parsed.rawText = blueprintText;
          return parsed;
        }
      } catch (e) {
        console.log('Blueprint parse error:', e);
      }
      return null;
    }
    
    // Store detected blueprints by ID for reliable retrieval
    let detectedBlueprints = {};
    
    function createBlueprintPreviewCard(blueprintData) {
      const folderCount = blueprintData.categories.length;
      const phraseCount = Object.values(blueprintData.phrases).reduce((sum, arr) => sum + arr.length, 0);
      
      // Store blueprint data with unique ID
      const cardId = 'bp_' + Date.now();
      detectedBlueprints[cardId] = blueprintData;
      
      // Quick preview folders (shown by default)
      const foldersHtml = blueprintData.categories.slice(0, 5).map(cat => 
        `<span class="blueprint-preview-folder">${cat.icon} ${cat.label}</span>`
      ).join('');
      const moreCount = blueprintData.categories.length - 5;
      
      // Detailed folders (shown on hover)
      const detailsHtml = blueprintData.categories.map(cat => {
        const phrases = blueprintData.phrases[cat.id] || [];
        const phrasesPreview = phrases.slice(0, 5).map(p => 
          `<span class="preview-phrase-chip">${escapeHTML(p.length > 25 ? p.substring(0, 25) + '...' : p)}</span>`
        ).join('');
        const morePhrasesCount = phrases.length - 5;
        
        return `
          <div class="preview-folder-section">
            <div class="preview-folder-header">
              <span class="preview-folder-color" style="background: ${cat.color}"></span>
              ${cat.icon} ${cat.label}
              <span style="color: #666; font-weight: 400; margin-left: auto;">${phrases.length}</span>
            </div>
            <div class="preview-folder-phrases">
              ${phrasesPreview}
              ${morePhrasesCount > 0 ? `<span class="preview-phrase-chip" style="color: #666;">+${morePhrasesCount}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      return `
        <div class="blueprint-preview-card" data-card-id="${cardId}">
          <div class="blueprint-preview-header">
            <span class="blueprint-preview-icon">${blueprintData.icon || ''}</span>
            <div class="blueprint-preview-info">
              <div class="blueprint-preview-name">${escapeHTML(blueprintData.name)}</div>
              <div class="blueprint-preview-meta">${folderCount} folders  ${phraseCount} phrases</div>
            </div>
          </div>
          <div class="blueprint-preview-folders">
            ${foldersHtml}
            ${moreCount > 0 ? `<span class="blueprint-preview-folder">+${moreCount} more</span>` : ''}
          </div>
          <div class="blueprint-preview-actions">
            <button class="blueprint-create-btn" onclick="createBlueprintFromCard('${cardId}')">
               Create Blueprint
            </button>
            <div class="blueprint-preview-details">
              ${detailsHtml}
            </div>
          </div>
        </div>
      `;
    }
    
    function createBlueprintFromCard(cardId) {
      const blueprintData = detectedBlueprints[cardId];
      if (!blueprintData) {
        showToast('Blueprint data not found');
        return;
      }
      
      const btn = document.querySelector(`[data-card-id="${cardId}"] .blueprint-create-btn`);
      
      // Check for duplicate names
      let finalName = blueprintData.name;
      let counter = 1;
      while (getAllBlueprints().some(b => b.name === finalName)) {
        counter++;
        finalName = `${blueprintData.name} (${counter})`;
      }
      
      // Create the blueprint
      const newBp = {
        id: 'ai_' + Date.now(),
        name: finalName,
        icon: blueprintData.icon || '',
        description: blueprintData.description || 'Created by Claude',
        categories: blueprintData.categories
      };
      
      customBlueprints.push(newBp);
      
      // Add phrases to library
      blueprintData.categories.forEach(cat => {
        if (!library[cat.id]) library[cat.id] = [];
        (blueprintData.phrases[cat.id] || []).forEach(p => {
          if (!library[cat.id].includes(p)) library[cat.id].push(p);
        });
      });
      
      // Auto-load the new blueprint
      currentBlueprintId = newBp.id;
      categories = newBp.categories.map(c => ({...c}));
      slots = {};
      categories.forEach(c => slots[c.id] = []);
      
      saveToStorage();
      renderLibrary();
      renderSlots();
      renderPreview();
      updateBlueprintButton();
      
      // Animate success
      if (btn) {
        btn.classList.add('success');
        btn.innerHTML = ' Created!';
      }
      
      // Haptic feedback
      if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
      
      showToast(` ${finalName} created!`);
      
      // Update suggestions
      updateSuggestions();
    }
    
    function useSuggestion(text) {
      const input = document.getElementById('assistantInput');
      input.value = text;
      input.focus();
    }
    
    function updateSuggestions() {
      const container = document.getElementById('assistantSuggestions');
      if (!container) return;
      
      const hasPrompt = categories.some(c => slots[c.id]?.length > 0);
      const lastMessage = chatHistory[chatHistory.length - 1];
      const hasBlueprint = lastMessage?.content?.includes('BLUEPRINT:');
      
      let suggestions = [];
      
      if (hasBlueprint) {
        suggestions = [
          { icon: '', text: 'Create a variation', action: "Create a variation of this blueprint with different categories" },
          { icon: '', text: 'Add more phrases', action: "Add 3 more phrases to each folder in this blueprint" },
          { icon: '', text: 'Different style', action: "Create a similar blueprint but for a different photography style" }
        ];
      } else if (hasPrompt) {
        suggestions = [
          { icon: '', text: 'Improve this', action: '' },
          { icon: '', text: 'More cinematic', action: 'Make it more cinematic' },
          { icon: '', text: 'Add details', action: 'Add more specific details about lighting and composition' }
        ];
      } else {
        suggestions = [
          { icon: '', text: 'Create a blueprint...', action: 'Create a blueprint for portrait photography' },
          { icon: '', text: 'Help me photograph...', action: 'Help me create a prompt for photographing ' },
          { icon: '', text: 'Product shots', action: 'Create a blueprint for product photography' }
        ];
      }
      
      container.innerHTML = suggestions.map(s => 
        `<button class="suggestion-chip" onclick="useSuggestion('${escapeHTML(s.action)}')">${s.icon} ${s.text}</button>`
      ).join('');
    }
    
    function showTypingIndicator() {
      const container = document.getElementById('assistantMessages');
      const div = document.createElement('div');
      div.className = 'assistant-typing';
      div.id = 'typingIndicator';
      div.innerHTML = '<span></span><span></span><span></span>';
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }
    
    function hideTypingIndicator() {
      document.getElementById('typingIndicator')?.remove();
    }
    
    function copySuggestion(btn) {
      const pre = btn.previousElementSibling;
      if (pre && pre.tagName === 'PRE') {
        const text = pre.textContent;
        if (navigator.clipboard) {
          navigator.clipboard.writeText(text).then(() => {
            showToast('Improved prompt copied!');
            btn.textContent = ' Copied!';
            setTimeout(() => btn.textContent = ' Copy improved prompt', 2000);
          });
        }
      }
    }
    
    async function sendToAssistant() {
      const input = document.getElementById('assistantInput');
      const sendBtn = document.getElementById('assistantSendBtn');
      const msg = input.value.trim();
      if (!msg || isWaitingForResponse) return;
      
      const apiKey = getApiKey();
      if (!apiKey) { showToast('Add your API key first'); return; }
      
      addMessage('user', msg);
      input.value = '';
      isWaitingForResponse = true;
      sendBtn.disabled = true;
      showTypingIndicator();
      
      const systemPrompt = `You are a helpful prompt engineering assistant inside "Prompt Blocks" app.
The user is building prompts for AI image generation (primarily Nano Banana Pro, but also other models).

Your job is to:
1. Understand what they're trying to create
2. Improve their prompt with better structure, detail, specificity
3. Provide the improved prompt in a code block

Keep explanations brief. Focus on the improved prompt.

When improving prompts, consider:
- Clear subject description
- Camera/framing details (medium shot, close-up, etc.)
- Lighting conditions
- Mood and atmosphere
- Style references
- Quality markers

Always wrap your improved prompt in a code block like this:
\`\`\`
Your improved prompt here
\`\`\`

If the user wants a BLUEPRINT (a reusable structure), output in this format:
\`\`\`
BLUEPRINT: Name Here
ICON: 
DESCRIPTION: Brief description

FOLDER: Category Name |  | #4ECDC4
- Phrase one
- Phrase two

FOLDER: Another Category |  | #FF6B6B
- Phrase one
- Phrase two
\`\`\``;

      chatHistory.push({ role: 'user', content: msg });
      
      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1024,
            system: systemPrompt,
            messages: chatHistory
          })
        });
        
        hideTypingIndicator();
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error?.message || 'API request failed');
        }
        
        const data = await response.json();
        const assistantMsg = data.content[0].text;
        chatHistory.push({ role: 'assistant', content: assistantMsg });
        addMessage('assistant', assistantMsg);
        
      } catch (error) {
        hideTypingIndicator();
        let errorMsg = error.message;
        if (errorMsg.includes('401') || errorMsg.includes('invalid')) {
          errorMsg = 'Invalid API key. Check your key and try again.';
          localStorage.removeItem('claudeApiKey');
          updateAssistantUI();
        } else if (errorMsg.includes('CORS') || errorMsg.includes('network')) {
          errorMsg = 'Network error. The API may not allow browser requests.';
        }
        addMessage('assistant', errorMsg, true);
        chatHistory.pop();
      }
      
      isWaitingForResponse = false;
      sendBtn.disabled = false;
    }
    
    // ============ EVENT LISTENERS ============
    document.getElementById('emojiPicker').addEventListener('click', e => {
      const opt = e.target.closest('.emoji-option');
      if (opt) { selectedEmoji = opt.dataset.emoji; updateEmojiSelection(); }
    });
    
    document.getElementById('newFolderName').addEventListener('keydown', e => {
      if (e.key === 'Enter') createNewFolder();
      if (e.key === 'Escape') closeFolderModal();
    });
    
    document.getElementById('saveNameInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') saveTemplate();
      if (e.key === 'Escape') hideSaveForm();
    });
    
    document.getElementById('assistantInput')?.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendToAssistant(); }
    });
    
    // Folder action buttons
    document.addEventListener('touchstart', e => {
      const colorBtn = e.target.closest('.folder-color-btn');
      const actionBtn = e.target.closest('.folder-action-btn');
      const folderLabel = editMode && e.target.closest('.folder-label');
      if (colorBtn || actionBtn || folderLabel) { e.preventDefault(); e.stopPropagation(); }
    }, { capture: true, passive: false });
    
    document.addEventListener('touchend', e => {
      const colorBtn = e.target.closest('.folder-color-btn');
      if (colorBtn) { e.preventDefault(); e.stopPropagation(); openColorPicker(colorBtn.dataset.categoryId); return; }
      
      const actionBtn = e.target.closest('.folder-action-btn');
      if (actionBtn) {
        e.preventDefault(); e.stopPropagation();
        const catId = actionBtn.dataset.categoryId;
        if (actionBtn.classList.contains('duplicate')) duplicateFolder(catId);
        else if (actionBtn.classList.contains('delete')) deleteFolder(catId);
        return;
      }
      
      if (editMode) {
        const label = e.target.closest('.folder-label');
        if (label) { e.preventDefault(); e.stopPropagation(); renameFolder(label.dataset.categoryId); }
      }
    }, { capture: true, passive: false });
    
    document.addEventListener('click', e => {
      const colorBtn = e.target.closest('.folder-color-btn');
      if (colorBtn) { e.preventDefault(); e.stopPropagation(); openColorPicker(colorBtn.dataset.categoryId); return; }
      
      const actionBtn = e.target.closest('.folder-action-btn');
      if (actionBtn) {
        e.preventDefault(); e.stopPropagation();
        const catId = actionBtn.dataset.categoryId;
        if (actionBtn.classList.contains('duplicate')) duplicateFolder(catId);
        else if (actionBtn.classList.contains('delete')) deleteFolder(catId);
        return;
      }
      
      if (editMode) {
        const label = e.target.closest('.folder-label');
        if (label) { e.preventDefault(); e.stopPropagation(); renameFolder(label.dataset.categoryId); }
      }
    }, { capture: true });
    
    // Color picker
    document.getElementById('colorPickerGrid').addEventListener('click', e => {
      const opt = e.target.closest('.color-option');
      if (opt && activeColorPicker) setFolderColor(activeColorPicker, opt.dataset.color);
    });
    
    document.getElementById('colorPickerOverlay').addEventListener('click', closeColorPicker);
    
    // Blueprint modal
    document.getElementById('blueprintOverlay').addEventListener('click', closeBlueprintModal);
    
    document.getElementById('blueprintGrid').addEventListener('click', e => {
      const exportBtn = e.target.closest('.blueprint-export-btn');
      if (exportBtn) { e.stopPropagation(); exportBlueprint(exportBtn.dataset.blueprintId); return; }
      
      const deleteBtn = e.target.closest('.blueprint-delete-btn');
      if (deleteBtn) { e.stopPropagation(); deleteBlueprint(deleteBtn.dataset.blueprintId); return; }
      
      const card = e.target.closest('.blueprint-card');
      if (card) loadBlueprint(card.dataset.blueprintId);
    });
    
    // Import text modal
    document.getElementById('importTextOverlay').addEventListener('click', closeImportTextModal);
    
    // Fix iOS URL-encoding paste bug
    document.getElementById('importTextArea').addEventListener('paste', function(e) {
      e.preventDefault();
      let text = (e.clipboardData || window.clipboardData).getData('text');
      // Decode if URL-encoded
      if (text.includes('%20') || text.includes('%0A')) {
        try {
          text = decodeURIComponent(text);
        } catch (err) {
          text = text.replace(/%20/g, ' ').replace(/%0A/g, '\n').replace(/%3A/g, ':').replace(/%7C/g, '|').replace(/%23/g, '#');
        }
      }
      // Insert at cursor position
      const ta = this;
      const start = ta.selectionStart;
      const end = ta.selectionEnd;
      ta.value = ta.value.substring(0, start) + text + ta.value.substring(end);
      ta.selectionStart = ta.selectionEnd = start + text.length;
    });
    
    // Add folder modal
    document.getElementById('addFolderOverlay').addEventListener('click', closeAddFolderModal);
    
    document.getElementById('addFolderGrid').addEventListener('click', e => {
      const item = e.target.closest('.add-folder-item');
      if (item) addFolderFromBlueprint(item.dataset.folderId, item.dataset.label, item.dataset.icon, item.dataset.color);
    });
    
    // ============ INIT ============
    initializeData();
    initDragSystem();
    renderLibrary();
    renderSlots();
    renderReferences();
    renderPreview();
    renderTemplateSelect();
    updateBlueprintButton();
  </script>
</body>
</html>
